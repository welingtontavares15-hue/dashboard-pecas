<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🧰 Solicitação de Peças — Local/Global (OneDrive Automático)</title>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#3b82f6;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--border:#334155;--shadow:0 4px 20px rgba(0,0,0,.2);
      --info:#06b6d4; --step:#8b5cf6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      background:var(--card);border-bottom:1px solid var(--border);
      padding:12px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:10;box-shadow:var(--shadow)
    }
    h1{font-size:18px;margin:0}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .badge{border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.04)}
    button{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer;transition:.2s}
    button:hover{background:var(--accent);color:#fff}
    .btn-ok{background:var(--ok);border:none;color:#fff}
    .btn-danger{background:var(--danger);border:none;color:#fff}
    main{max-width:1200px;margin:0 auto;padding:20px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .grid>label{grid-column:span 3;align-self:end;color:var(--muted);font-size:13px}
    .grid>input,.grid>textarea,.grid>select{grid-column:span 9}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.grid>label,.grid>*{grid-column:auto}}
    input,select,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    input[readonly]{opacity:.9}
    #municipio,#uf{ text-align:center }

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:middle}
    th{position:sticky;top:60px;background:var(--card)}
    tr:hover{background:rgba(255,255,255,.04)}
    @media (max-width:680px){ #tabela-itens td .desc{display:block;width:100%} }
    td input, td select{width:100%}

    .total-box{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;font-weight:600}
    .total-box input{width:140px;text-align:right}

    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:50}
    .toast.show{display:block}
    .small-hint{color:var(--muted); font-size:12px; margin-top:6px}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);max-width:900px;width:96%;padding:16px}
    .modal h3{margin:0 0 10px 0}
    .modal .config-grid{display:grid;gap:10px;margin:14px 0}
    .modal .config-grid label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
    .modal .config-grid input,.modal .config-grid textarea,.modal .config-grid select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .modal .config-grid textarea{min-height:110px;resize:vertical}

    select.status{width:auto;min-width:160px;border:none;color:#fff;font-weight:600;border-radius:8px;padding:6px 8px}
    select.status.flow-sup{background:var(--warn)}
    select.status.flow-forn{background:var(--info)}
    select.status.flow-rota{background:var(--step)}
    select.status.flow-ent{background:var(--ok)}
    .hist-empty{color:var(--muted); padding:10px 0}
    #tabela-hist td:last-child{display:flex;gap:8px;justify-content:flex-end}
    .btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--text)}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:10px;align-items:center">
      <h1>🧰 Solicitação de Peças</h1>
      <span id="badge-modo" class="badge">Modo: GLOBAL</span>
    </div>
    <div class="toolbar">
      <button id="btn-modo-local">💾 Local</button>
      <button id="btn-modo-global">☁️ Global</button>
      <button id="btn-onedrive-config" class="btn-ghost">⚙️ OneDrive</button>
      <button id="btn-global-sync" class="btn-ghost">🔄 Atualizar nuvem</button>
      <button id="btn-xlsx">📊 Excel</button>
      <button id="btn-pdf">📄 PDF</button>
      <button id="btn-enviar" class="btn-ok">🚀 Enviar</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>🔧 Dados da Solicitação</h2>
      <div class="grid">
        <label for="req-num">Nº Solicitação</label>
        <input id="req-num" readonly>

        <label for="tecnico">Técnico</label>
        <input id="tecnico" list="tecnicos" placeholder="Selecione o técnico">
        <datalist id="tecnicos"></datalist>

        <label>Endereço</label>
        <input id="endereco" readonly>

        <label>Bairro</label>
        <input id="bairro" readonly>

        <label>Município</label>
        <input id="municipio" readonly>

        <label>UF</label>
        <input id="uf" readonly>

        <label>CEP</label>
        <input id="cep" readonly>

        <label for="envio">Tipo de Envio</label>
        <select id="envio">
          <option value="Normal">Normal</option>
          <option value="Sedex">Sedex</option>
        </select>

        <label>Observações</label>
        <textarea id="obs" rows="2" placeholder="Observações..."></textarea>
      </div>
      <div class="small-hint">Atalhos: <kbd>Ctrl</kbd> + <kbd>Enter</kbd> = adicionar item • <kbd>Ctrl</kbd> + <kbd>E</kbd> = enviar</div>
    </section>

    <section class="card">
      <h2>📦 Itens da Solicitação</h2>
      <datalist id="pecas"></datalist>
      <table id="tabela-itens">
        <thead>
          <tr>
            <th style="width:120px">Código</th>
            <th>Descrição</th>
            <th style="width:200px">ID Máquina</th>
            <th style="width:90px">Qtd</th>
            <th style="width:150px">Valor Unitário</th>
            <th style="width:150px">Subtotal</th>
            <th style="width:110px">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="add-item" type="button" class="btn-ok">➕ Adicionar Item</button>
        <div class="total-box">
          Subtotal: <span id="subtotal">R$ 0,00</span> ·
          Desconto (R$): <input id="desc-valor" type="number" step="0.01" min="0" value="0"> ·
          Frete (R$): <input id="frete" type="number" step="0.01" value="0"> ·
          <strong>Total:</strong> <span id="total-geral">R$ 0,00</span>
        </div>
      </div>
    </section>

    <section class="card" id="hist">
      <div class="toolbar" style="justify-content:space-between;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <h2 style="margin:0">📚 Histórico</h2>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btn-hist-mostrar" type="button" class="btn-ghost">👁️ Mostrar</button>
          <button id="btn-hist-ocultar" type="button" class="btn-ghost">🙈 Ocultar</button>
          <button id="btn-hist" type="button" class="btn-ok">Atualizar</button>
          <button id="hist-del" class="btn-danger" title="Excluir pedidos selecionados">🗑️ Excluir selecionados</button>
        </div>
      </div>
      <div id="hist-content">
        <div class="hist-empty" id="hist-empty" style="display:none">Sem registros.</div>
        <table id="tabela-hist">
          <thead>
            <tr>
              <th style="width:36px; text-align:center"><input id="hist-select-all" type="checkbox" title="Selecionar todos"></th>
              <th>Nº</th>
              <th>Data</th>
              <th>Técnico</th>
              <th>Itens</th>
              <th>Total</th>
              <th>Fluxo</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Configuração OneDrive -->
  <div id="modal-onedrive" class="modal-backdrop">
    <div class="modal">
      <h3>☁️ Configurar OneDrive compartilhado</h3>
      <p class="muted">
        Cole o <strong>link do arquivo</strong> <code>pedidos.json</code> (ou um <code>shareId</code> iniciando com
        <code>u!</code>/<code>s!</code>) e o <strong>token (Bearer)</strong> do Microsoft Graph (Files.ReadWrite).<br>
        Não precisa converter: o sistema aceita o link direto e transforma automaticamente.
      </p>
      <div class="config-grid">
        <div>
          <label for="onedrive-share">Link do arquivo / shareId</label>
          <input id="onedrive-share" type="url" placeholder="https://.../pedidos.json (ou u!abc...)" autocomplete="off">
        </div>
        <div>
          <label for="onedrive-token">Token de acesso (Bearer)</label>
          <textarea id="onedrive-token" placeholder="eyJ0eXAiOiJKV1QiLCJhbGciOi..."></textarea>
        </div>
        <div class="inline" style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1 1 180px">
            <label for="onedrive-refresh-min">Atualização automática (min)</label>
            <input id="onedrive-refresh-min" type="number" min="1" step="1" value="10">
          </div>
          <div style="flex:1 1 220px">
            <label for="onedrive-arquivo">Nome do arquivo</label>
            <input id="onedrive-arquivo" type="text" value="pedidos.json">
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="onedrive-cancelar">Cancelar</button>
        <button id="onedrive-testar" class="btn-ghost">Testar conexão</button>
        <button id="onedrive-salvar" class="btn-ok">Salvar configuração</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  'use strict';
  /* ========= Helpers ========= */
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => document.querySelectorAll(s);
  const BRL = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  const toast = (m, ms = 2200) => { const t = $('#toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), ms); };
  const clamp = (v, min, max) => Math.min(max, Math.max(min, Number(v || 0)));
  const collator = new Intl.Collator('pt-BR', { sensitivity: 'base' });

  /* ========= Bases ========= */
  const itensBase = [
    {"codigo":"CS001","descricao":"Adaptador Braço Lavagem HD-80","valor":225.00},
    {"codigo":"CS002","descricao":"Adaptador Do Braço De Lavagem (Tarugo) HD-50","valor":175.70},
    {"codigo":"CS003","descricao":"Adaptador Do Braço De Lavagem (Tarugo) HD-80","valor":205.00},
    {"codigo":"CS004","descricao":"Adaptador Interno HD-80","valor":350.00},
    {"codigo":"CS005","descricao":"Arruela De Rotação HD-80","valor":40.00},
    {"codigo":"CS006","descricao":"Assento Do Braço De Lavagem (Bucha) HD-50","valor":101.00},
    {"codigo":"CS007","descricao":"Batente Lateral HD-80","valor":105.00},
    {"codigo":"CS008","descricao":"Bicos Injetores Do Braço HD-50/HD-80","valor":114.48},
    {"codigo":"CS009","descricao":"Boiler HD-50","valor":2033.00},
    {"codigo":"CS010","descricao":"Boiler HD-80","valor":2355.00},
    {"codigo":"CS011","descricao":"Boma De Enxague (Importada) HD-50","valor":2007.79},
    {"codigo":"CS012","descricao":"Boma De Enxague (Nacional) HD-80","valor":1550.00},
    {"codigo":"CS013","descricao":"Bomba De Lavagem HD-50","valor":7529.22},
    {"codigo":"CS014","descricao":"Bomba De Lavagem HD-80","valor":11293.85},
    {"codigo":"CS015","descricao":"Braço Capo HD-80","valor":1255.00},
    {"codigo":"CS016","descricao":"Braço De Lavagem HD-50","valor":1205.00},
    {"codigo":"CS017","descricao":"Braço De Lavagem Superior Completo HD-80","valor":1715.00},
    {"codigo":"CS018","descricao":"Caixa De Montagem Elétrica HD-80","valor":680.00},
    {"codigo":"CS019","descricao":"Caixa De Montagem HD-50","valor":225.88},
    {"codigo":"CS020","descricao":"Capa Do Filtro De Residuo HD-50","valor":150.60},
    {"codigo":"CS021","descricao":"Capo HD-80","valor":5020.00},
    {"codigo":"CS022","descricao":"Cesto De Resíduo HD-80","valor":150.60},
    {"codigo":"CS023","descricao":"Chicote NR12","valor":3210.00},
    {"codigo":"CS024","descricao":"Conexão Braço HD-80","valor":1507.00},
    {"codigo":"CS025","descricao":"Conj Termostato","valor":886.72},
    {"codigo":"CS026","descricao":"Conjunto de cesto de residuo NT-300","valor":1123.05},
    {"codigo":"CS027","descricao":"Contactora De Comando HD-80","valor":328.00},
    {"codigo":"CS028","descricao":"Contatora HD-50","valor":328.00},
    {"codigo":"CS029","descricao":"Curva Braço Superior HD-50","valor":115.00},
    {"codigo":"CS030","descricao":"Disjuntor 10A HD-80","valor":375.00},
    {"codigo":"CS031","descricao":"Disjuntor 125A","valor":1776.85},
    {"codigo":"CS032","descricao":"Disjuntor 80A","valor":313.20},
    {"codigo":"CS033","descricao":"Eixo De Suporte Do Braço HD-50","valor":301.50},
    {"codigo":"CS034","descricao":"Etiqueta Painel NT","valor":545.90},
    {"codigo":"CS035","descricao":"Filtro De Residuo HD-50","valor":742.00},
    {"codigo":"CS036","descricao":"Filtro De Residuo Hdw-80 HD-80","valor":401.56},
    {"codigo":"CS037","descricao":"Fim de curso HDW-200","valor":789.21},
    {"codigo":"CS038","descricao":"Fim de curso HDW-200 (Completo)","valor":2175.50},
    {"codigo":"CS039","descricao":"Flange Braço Inferior HD-50","valor":742.00},
    {"codigo":"CS040","descricao":"Flange Braço Superior HD-50","valor":742.00},
    {"codigo":"CS041","descricao":"Flauta De Enxague (S/ Bicos) HD-80","valor":125.50},
    {"codigo":"CS042","descricao":"Flauta Do Braço HD-50","valor":125.50},
    {"codigo":"CS043","descricao":"Flauta HD-80","valor":1204.75},
    {"codigo":"CS044","descricao":"Fonte 24V 10A HD-50/HD-80","valor":155.00},
    {"codigo":"CS045","descricao":"Kit Mangueiras (Agua + Dreno) HD-50/HD-80","valor":240.00},
    {"codigo":"CS046","descricao":"Luva Braço Superior HD-50","valor":90.00},
    {"codigo":"CS047","descricao":"Mangueira De Borracha HD-80","valor":95.00},
    {"codigo":"CS048","descricao":"Mola Da Porta HD-50","valor":75.00},
    {"codigo":"CS049","descricao":"Mola Do Capo HD-80","valor":830.00},
    {"codigo":"CS050","descricao":"Painel Elétrico Completo HD-50","valor":9550.00},
    {"codigo":"CS051","descricao":"Painel Ihm HD-50/HD-80","valor":1588.00},
    {"codigo":"CS052","descricao":"Parafuso Da Rondana HD-50","valor":75.29},
    {"codigo":"CS053","descricao":"Parafuso De Fixação Braço De Lavagem HD-80","valor":105.00},
    {"codigo":"CS054","descricao":"Parafuso De Fixação Da Polia HD-80","valor":145.00},
    {"codigo":"CS055","descricao":"Pino Batente Lateral Capo HD-80","valor":130.00},
    {"codigo":"CS056","descricao":"Placa Controladora HD-50/HD-80","valor":6307.00},
    {"codigo":"CS057","descricao":"Placa De Montagem HD-50","valor":280.00},
    {"codigo":"CS058","descricao":"Polia De Movimentação Do Capo HD-80","valor":135.00},
    {"codigo":"CS059","descricao":"Polia Inferior Do Capo HD-80","valor":150.00},
    {"codigo":"CS060","descricao":"Porta HD-50","valor":1760.00},
    {"codigo":"CS061","descricao":"Pressostato De Nível HD-50","valor":610.00},
    {"codigo":"CS062","descricao":"Pressostato HDW-200","valor":453.68},
    {"codigo":"CS063","descricao":"Pressotato De Nível HD-80","valor":572.40},
    {"codigo":"CS064","descricao":"Pulmão HD-80","valor":500.00},
    {"codigo":"CS065","descricao":"Relé De Proteção HD-50/HD-80","valor":414.11},
    {"codigo":"CS067","descricao":"Resistencia do booster HDW-200","valor":1696.00},
    {"codigo":"CS068","descricao":"Resistencia Do Tanque Com Flange Hd50","valor":1017.60},
    {"codigo":"CS069","descricao":"Resistencia Do Tanque Com Flange Hd80","valor":1023.00},
    {"codigo":"CS070","descricao":"Resistencia do TQ HDW-200","valor":1346.73},
    {"codigo":"CS071","descricao":"Resistencia NT-300","valor":1696.00},
    {"codigo":"CS072","descricao":"Resistências Boiler Com Flange Hd50","valor":1272.00},
    {"codigo":"CS073","descricao":"Resistências Boiler Com Flange Hd80","valor":1484.00},
    {"codigo":"CS074","descricao":"Roldana HD-80","valor":163.50},
    {"codigo":"CS075","descricao":"Rondana Da Porta HD-50","valor":75.00},
    {"codigo":"CS076","descricao":"Saida Do Dreno HD-50","valor":476.85},
    {"codigo":"CS077","descricao":"Sensor Capo HD-80","valor":108.45},
    {"codigo":"CS078","descricao":"Sensor De Nivel HD-50","valor":606.74},
    {"codigo":"CS079","descricao":"Sensor De Nível HD-80","valor":606.74},
    {"codigo":"CS080","descricao":"Sensor De Temperatura HD-50","valor":255.00},
    {"codigo":"CS081","descricao":"Solenoide De Agua HD-50","valor":175.00},
    {"codigo":"CS082","descricao":"Sonda Temperatura","valor":320.51},
    {"codigo":"CS083","descricao":"Suporte Bomba De Lavagem HD-80","valor":75.00},
    {"codigo":"CS084","descricao":"Suporte Braço Capo HD-80","valor":40.00},
    {"codigo":"CS085","descricao":"Suporte Capo HD-80","valor":150.00},
    {"codigo":"CS086","descricao":"Suporte Do Boiler HD-80","valor":225.00},
    {"codigo":"CS087","descricao":"Suporte Do Rack HD-80","valor":1255.00},
    {"codigo":"CS088","descricao":"Suporte Fixação HD-80","valor":155.00},
    {"codigo":"CS089","descricao":"Suporte Gancho Bomba De Lavagem HD-80","valor":350.00},
    {"codigo":"CS090","descricao":"Suporte Luva Para Mangeira Do Dreno HD-80","valor":276.00},
    {"codigo":"CS091","descricao":"Suporte Painel HD-80","valor":405.00},
    {"codigo":"CS092","descricao":"Suporte Regulável De Altura(Pé) HD-80","valor":335.00},
    {"codigo":"CS093","descricao":"Suporte Termostato Do Boiler HD-80","valor":51.00},
    {"codigo":"CS094","descricao":"Tampa Frontal HD-50","valor":602.34},
    {"codigo":"CS095","descricao":"Tampa Frontal HD-80","valor":230.00},
    {"codigo":"CS096","descricao":"Tampa Inferior HD-50","valor":502.00},
    {"codigo":"CS097","descricao":"Tampa Inferior Traseira HD-50","valor":955.00},
    {"codigo":"CS098","descricao":"Tampa Lateral Direita HD-50","valor":905.00},
    {"codigo":"CS099","descricao":"Tampa Lateral HD-80","valor":705.00},
    {"codigo":"CS100","descricao":"Tampa Superior HD-50","valor":1130.00},
    {"codigo":"CS101","descricao":"Tampa Superior HD-80","valor":205.00},
    {"codigo":"CS102","descricao":"Tampa Traseira HD-50","valor":1005.00},
    {"codigo":"CS103","descricao":"Tampa Traseira HD-80","valor":715.00},
    {"codigo":"CS104","descricao":"Tampao Do Dreno HD-50","valor":119.06},
    {"codigo":"CS105","descricao":"Tampão Do Dreno HD-80","valor":183.60},
    {"codigo":"CS106","descricao":"Tela De Filtro De Resíduo Direito HD-80","valor":337.61},
    {"codigo":"CS107","descricao":"Tela De Filtro De Resíduo Esquerdo HD-80","valor":337.61},
    {"codigo":"CS108","descricao":"Terminal De Aterramento HD-50","valor":55.50},
    {"codigo":"CS109","descricao":"Termostato Do Boiler HD-50/H80","valor":901.00},
    {"codigo":"CS110","descricao":"Termostato Do Tanque HD/HD-80","valor":254.40},
    {"codigo":"CS111","descricao":"Trilho Dim HD-50/HD-80","valor":40.00},
    {"codigo":"CS112","descricao":"Tubo Braço Lavagem Superior HD-80","valor":1635.00},
    {"codigo":"CS113","descricao":"Tubo Da Bomba De Lavagem (Mangote Curvo) HD-80","valor":350.00},
    {"codigo":"CS114","descricao":"Tubo De Drenagem Hdw-80 HD-80","valor":355.00},
    {"codigo":"CS115","descricao":"Tubo De Saida Da Bomba De Lavagem HD-50","valor":225.88},
    {"codigo":"CS116","descricao":"Tubo Saida Bomba De Lavagem HD-80","valor":263.55},
    {"codigo":"CS117","descricao":"Tupo Braço Superior HD-50","valor":52.00},
    {"codigo":"CS118","descricao":"Valvula De Agua HD-80","valor":159.00},
    {"codigo":"CS119","descricao":"Valvula Solenoide HDW-200 NT","valor":172.50},
    {"codigo":"CS120","descricao":"Etiqueta Painel","valor":69.00}
  ];

  const tecnicosBase = {
    "Antonio Ferreira De Santana Filho":{"endereco":"Av Curió - Campanário, Ap 510 Bloco B","bairro":"","cep":"09.925-000","municipio":"Diadema","uf":"SP"},
    "Antonio Rocker":{"endereco":"Rua Estoril 131","bairro":"Veleiros","cep":"47.730-900","municipio":"São Paulo","uf":"SP"},
    "Brunno Diniz Mendes":{"endereco":"Rua da Granja S/N, Condomínio Plaza Norte Residence, Bloco 06C AP 010","bairro":"Maiobinha","cep":"65120-176","municipio":"São José de Ribamar","uf":"MA"},
    "Carlos Alberto De Vasconcelos Junior":{"endereco":"Deputado João Ursulo Ribeiro Filho A 149","bairro":"Mangabeira I","cep":"58.055-360","municipio":"João Pessoa","uf":"PB"},
    "Dalvino Carlos Santos Junior":{"endereco":"Rua vivaldo sales 158, apartamento 41","bairro":"jardim são josé","cep":"11-430 140","municipio":"guarujá são paulo","uf":"SP"},
    "Davidson Alves Vitorino":{"endereco":"Jacarandá N° 157","bairro":"Sapucaias 3","cep":"32.071-236","municipio":"Contagem","uf":"MG"},
    "Diego Abner de Oliveira":{"endereco":"Rua Mário Campos 71 AP 401 Bloco 08","bairro":"","cep":"12.221-750","municipio":"São Jose do Campos","uf":"SP"},
    "Ednaldo Silva Costa":{"endereco":"Rua Olimpío Cassimiro Mendonça, 542","bairro":"Parque das Américas","cep":"38.045-360","municipio":"Uberaba","uf":"MG"},
    "Ediveton Pedro Da Silva":{"endereco":"Rua Mário Prieto 500","bairro":"Jardim Paulista","cep":"13.310-000","municipio":"Itu","uf":"SP"},
    "Eduardo Martins":{"endereco":"Rua Rafael da Silva e Souza N°510","bairro":"Cidade Líder","cep":"08280-090","municipio":"São Paulo","uf":"SP"},
    "Emerson Ribeiro":{"endereco":"Rua São Cristóvão, 471 Casa 03","bairro":"","cep":"88.080-320","municipio":"Florianópolis","uf":"SC"},
    "Fernando Silva":{"endereco":"Hermelindo Lazarini, 69","bairro":"Jardim das Nações","cep":"79.081-714","municipio":"Campo Grande","uf":"MS"},
    "Getulio Santos De Almeida":{"endereco":"Rua Nara Leão, N° 125. Apto Jarmim 1103","bairro":"Jardim Limoeiro","cep":"29.164-125","municipio":"Serra","uf":"ES"},
    "Humberto Elias Dos Santos Da Silva":{"endereco":"Av Jose Aloisio Filho N° 411 Apto 368 Bloco Q","bairro":"Humaita","cep":"90.250-180","municipio":"Porto Alegre","uf":"RS"},
    "Joao Celso Silva De Souza":{"endereco":"Leonardo da Vinci 96 Bloco C Ap 306","bairro":"Curado II","cep":"54.220-000","municipio":"Jaboatão dos Guararapes","uf":"PE"},
    "Leandro Rocha Cruz":{"endereco":"R. Dom Pedro II 537A Fundos","bairro":"Centro","cep":"14.820-290","municipio":"Cidade Américo Brasiliense - SP","uf":"SP"},
    "Maicon Cordeiro Chaves":{"endereco":"Rua Saxonia N°2013","bairro":"Vila Itoupava","cep":"89075-255","municipio":"Blumenau","uf":"SC"},
    "Marcio Andrade Dos Santos":{"endereco":"1° Travessa Renato Lima de Carvalho N° 33","bairro":"Jardim Alvorada","cep":"42.850-000","municipio":"Dias davila","uf":"BA"},
    "Marlon de Queiroz":{"endereco":"AV. Juscelino Kubitschek, 3700 Bloco-E, Apto -301","bairro":"Passare","cep":"60.861.634","municipio":"Fortaleza","uf":"CE"},
    "Ney Goncalves Cardoso":{"endereco":"Rua Juqueri,266","bairro":"Irajá","cep":"21.371-370","municipio":"Rio de Janeiro","uf":"RJ"},
    "Pedro Gabriel Reis Nunes":{"endereco":"Rua Cristo Rei, 230, casa 101.","bairro":"São José","cep":"97095-680","municipio":"Santa Maria","uf":"RS"},
    "Rodrigo Lazari De Carvalho":{"endereco":"Rua alonso Vasconcelos pacheco 1327","bairro":"","cep":"09310-695","municipio":"Maua","uf":"SP"},
    "Sebastião Gomes Ribeiro":{"endereco":"RUA THOME DE SOUZA, 335","bairro":"LAGOA GRANDE – SEDE","cep":"45.810-000","municipio":"PORTO SEGURO","uf":"BA"},
    "Welington Bastos Tavares":{"endereco":"AV Morumbi Qd 34 Lt 11","bairro":"Vila Mariana","cep":"75.134-550","municipio":"Anápolis","uf":"GO"}
  };

  /* ========= Config ========= */
  const LS = { ORD:'sp_orders_v3', CUR:'sp_current_v3', SEQ:'sp_seq_v1', MODO:'sp_modo_integracao', ONEDRIVE:'sp_onedrive_cfg_v1' };
  const GLOBAL_REFRESH_MIN_DEFAULT = 10;
  const DEFAULT_ONEDRIVE = { shareUrl:'', accessToken:'', refreshMinutes:GLOBAL_REFRESH_MIN_DEFAULT, fileName:'pedidos.json' };
  const getModo = () => localStorage.getItem(LS.MODO) || 'global';
  const setModo = (m) => { localStorage.setItem(LS.MODO, m); $('#badge-modo').textContent = 'Modo: ' + m.toUpperCase(); gerarNumero(); if (m === 'global') montarHistoricoGlobal({refresh:true}); else montarHistoricoLocal(); };

  /* ========= OneDrive Sync ========= */
  const OneDriveStore = (()=>{
    const DEFAULT = { shareUrl:'', accessToken:'', refreshMinutes:GLOBAL_REFRESH_MIN_DEFAULT, fileName:'pedidos.json' };

    function parseStored(){
      try { return { ...DEFAULT, ...JSON.parse(localStorage.getItem(LS.ONEDRIVE) || '{}') }; }
      catch(e){ return { ...DEFAULT }; }
    }
    function sanitizeMinutes(v){ const n = parseInt(v, 10); return Number.isFinite(n) && n > 0 ? n : GLOBAL_REFRESH_MIN_DEFAULT; }
    function normalize(cfg={}){
      const merged = { ...DEFAULT, ...cfg };
      merged.shareUrl = (merged.shareUrl || '').trim();
      merged.accessToken = (merged.accessToken || '').trim();
      merged.refreshMinutes = sanitizeMinutes(merged.refreshMinutes);
      if (!merged.fileName) merged.fileName = 'pedidos.json';
      return merged;
    }
    function getConfig(){ return normalize(parseStored()); }
    function setConfig(newCfg={}){
      const normalized = normalize({ ...parseStored(), ...newCfg });
      localStorage.setItem(LS.ONEDRIVE, JSON.stringify(normalized));
      return normalized;
    }
    function stripParams(u){ return String(u || '').split('#')[0].split('?')[0]; }
    const isShareId = (s) => /^(u|s)![A-Za-z0-9_-]+$/.test(String(s || ''));
    function toShareToken(raw){
      const v = (raw || '').trim();
      if (!v) throw new Error('Informe o link/ID de compartilhamento do OneDrive.');
      if (isShareId(v)) return v;
      if (/^https?:/i.test(v)){
        const url = stripParams(v);
        const b64url = btoa(url).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
        return 'u!' + b64url;
      }
      const b64url = btoa(v).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
      return 'u!' + b64url;
    }
    function contentUrl(cfg){
      return `https://graph.microsoft.com/v1.0/shares/${toShareToken(cfg.shareUrl)}/driveItem/content`;
    }
    async function loadWith(cfg){
      const c = normalize(cfg);
      if (!c.shareUrl) throw new Error('Informe o link/ID compartilhado do arquivo JSON no OneDrive.');
      if (!c.accessToken) throw new Error('Cole o token (Bearer) do Microsoft Graph.');
      const res = await fetch(contentUrl(c), {
        headers: { 'Authorization': `Bearer ${c.accessToken}`, 'Accept': 'application/json' }
      });
      if (res.status === 401) throw new Error('Token inválido ou expirado (401).');
      if (res.status === 403) throw new Error('Sem permissão (403).');
      if (res.status === 404){
        return { orders: [], etag: res.headers.get('ETag') || res.headers.get('etag') || null };
      }
      if (!res.ok){
        const msg = await res.text().catch(()=>'' );
        throw new Error(`Erro ao ler arquivo (${res.status}): ${msg.slice(0,200)}`);
      }
      const etag = res.headers.get('ETag') || res.headers.get('etag') || null;
      const text = await res.text();
      const trimmed = (text || '').trim();
      let lista = [];
      if (trimmed){
        try {
          const parsed = JSON.parse(trimmed);
          if (Array.isArray(parsed)) lista = parsed;
          else if (Array.isArray(parsed.orders)) lista = parsed.orders;
          else throw new Error('Formato JSON inválido (esperado array ou {orders:[...]})');
        } catch(e){ throw new Error('Conteúdo JSON inválido no arquivo do OneDrive.'); }
      }
      return { orders: lista, etag };
    }
    async function saveWith(cfg, orders, etag){
      const c = normalize(cfg);
      if (!c.shareUrl || !c.accessToken) throw new Error('Config incompleta (link e token).');
      const res = await fetch(contentUrl(c), {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${c.accessToken}`,
          'Content-Type': 'application/json',
          'If-Match': etag || '*'
        },
        body: JSON.stringify(orders, null, 2)
      });
      if (res.status === 401) throw new Error('Token inválido ou expirado (401).');
      if (res.status === 403) throw new Error('Sem permissão (403).');
      if (res.status === 412) throw new Error('Conflito (412): alguém alterou o arquivo. Clique em “Atualizar nuvem” e tente novamente.');
      if (!res.ok){
        const msg = await res.text().catch(()=>'' );
        throw new Error(`Erro ao salvar (${res.status}): ${msg.slice(0,200)}`);
      }
      return { etag: res.headers.get('ETag') || res.headers.get('etag') || null };
    }
    async function testConfig(cfg){ return loadWith(cfg); }
    return { getConfig, setConfig, loadWith, saveWith, testConfig };
  })();

  const GLOBAL_CACHE = { orders:[], etag:null, loaded:false, loading:null, lastSync:0 };
  function normalizePedido(raw={}){
    const itens = Array.isArray(raw.itens)
      ? raw.itens.map(it=>({
          codigo:(it.codigo||'').toString().trim().toUpperCase(),
          descricao:it.descricao||'',
          idMaquina:(it.idMaquina||it.id||'').toString(),
          qtd:Number(it.qtd||0)||0,
          valor:Number(it.valor||0)||0,
          subtotal:Number(it.subtotal||((Number(it.qtd||0)||0)*(Number(it.valor||0)||0)))||0
        }))
      : [];
    return {
      numero:(raw.numero||'').toString(),
      data:raw.data || new Date().toISOString().slice(0,10),
      tecnico:raw.tecnico || '',
      endereco:raw.endereco || '',
      bairro:raw.bairro || '',
      municipio:raw.municipio || '',
      uf:raw.uf || '',
      cep:raw.cep || '',
      envio:raw.envio || 'Normal',
      obs:raw.obs || '',
      subtotal:Number(raw.subtotal||0)||0,
      total:Number(raw.total||0)||0,
      descValor:Number(raw.descValor||0)||0,
      frete:Number(raw.frete||0)||0,
      status:raw.status || 'Supervisor Diversey',
      itens
    };
  }
  function setGlobalState(lista, etag){
    GLOBAL_CACHE.orders = (lista||[]).map(normalizePedido);
    GLOBAL_CACHE.etag = etag || null;
    GLOBAL_CACHE.loaded = true;
    GLOBAL_CACHE.lastSync = Date.now();
  }
  async function ensureGlobalCache(force=false){
    if (GLOBAL_CACHE.loading){
      try { await GLOBAL_CACHE.loading; } catch(_){ }
      if (!force) return GLOBAL_CACHE;
    }
    const cfg = OneDriveStore.getConfig();
    const refreshMs = Math.max(1, Number(cfg.refreshMinutes||GLOBAL_REFRESH_MIN_DEFAULT)) * 60_000;
    if (!force && GLOBAL_CACHE.loaded && (Date.now()-GLOBAL_CACHE.lastSync) < refreshMs){
      return GLOBAL_CACHE;
    }
    const promise = OneDriveStore.loadWith(cfg).then(({orders, etag})=>{ setGlobalState(orders, etag); return GLOBAL_CACHE; });
    GLOBAL_CACHE.loading = promise;
    try { await promise; } finally { GLOBAL_CACHE.loading = null; }
    return GLOBAL_CACHE;
  }
  async function salvarListaGlobal(lista){
    const cfg = OneDriveStore.getConfig();
    const atual = (lista||[]).map(normalizePedido);
    const { etag } = await OneDriveStore.saveWith(cfg, atual, GLOBAL_CACHE.etag);
    setGlobalState(atual, etag);
    return atual;
  }

  /* ========= Datalists ========= */
  function preencherListas(){
    const dlT = $('#tecnicos');
    dlT.innerHTML = '';
    Object.keys(tecnicosBase).sort(collator.compare).forEach(n=>{
      const o = document.createElement('option');
      o.value = n;
      dlT.appendChild(o);
    });
    const dlP = $('#pecas');
    dlP.innerHTML = '';
    itensBase.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.codigo;
      o.label = `${p.codigo} — ${p.descricao} — ${BRL(p.valor)}`;
      dlP.appendChild(o);
    });
  }
  function preencherEndereco(nome){
    const d = tecnicosBase[nome];
    if (!d) return;
    $('#endereco').value = d.endereco || '';
    $('#bairro').value = d.bairro || '';
    $('#municipio').value = d.municipio || '';
    $('#uf').value = d.uf || '';
    $('#cep').value = d.cep || '';
  }

  /* ========= Itens ========= */
  function normalizeCode(v){
    if (!v) return null;
    const raw = String(v).toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (/^CS\d{1,3}$/.test(raw)) return 'CS' + raw.slice(2).padStart(3,'0');
    if (/^\d{1,3}$/.test(raw)) return 'CS' + raw.padStart(3,'0');
    return null;
  }
  function findItem(input){
    const norm = normalizeCode(input);
    if (norm){ return itensBase.find(x=>x.codigo===norm) || null; }
    const s = (input||'').toString().trim().toLowerCase();
    return itensBase.find(x=>x.descricao.toLowerCase().startsWith(s)) || null;
  }
  function addRow(pref={}){
    const tb = $('#tabela-itens tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input list="pecas" class="codigo" placeholder="CS001" value="${pref.codigo||''}"></td>
      <td><input class="desc" placeholder="Digite nome/código da peça" value="${pref.descricao||''}"></td>
      <td><input class="idmaq" placeholder="Ex.: HLHDW8017-027" value="${(pref.idMaquina||'')}"></td>
      <td><input type="number" class="qtd" min="1" value="${clamp(pref.qtd||1,1,9999)}"></td>
      <td><input type="number" class="valor" step="0.01" min="0" value="${Math.max(0,Number(pref.valor||0))||''}"></td>
      <td class="sub">R$ 0,00</td>
      <td><button class="btn-danger del" type="button">Excluir</button></td>`;
    tb.appendChild(tr);

    const iCod = tr.querySelector('.codigo');
    const iDesc = tr.querySelector('.desc');
    const iQtd = tr.querySelector('.qtd');
    const iVal = tr.querySelector('.valor');

    function fill(it){ iCod.value = it.codigo; iDesc.value = it.descricao; iVal.value = it.valor; }

    iCod.addEventListener('change',()=>{ const it=findItem(iCod.value); if(it) fill(it); calcTotal(); });
    iDesc.addEventListener('change',()=>{ const it=findItem(iDesc.value); if(it) fill(it); calcTotal(); });
    iQtd.addEventListener('input',()=>{ iQtd.value = clamp(iQtd.value,1,9999); calcTotal(); });
    iVal.addEventListener('input',()=>{ iVal.value = Math.max(0,Number(iVal.value||0)); calcTotal(); });
    tr.querySelector('.del').addEventListener('click',(e)=>{ e.preventDefault(); tr.remove(); calcTotal(); });

    if (pref.codigo){ const it=findItem(pref.codigo); if(it) fill(it); }
    calcTotal();
  }
  function collectItems(){
    const itens = [];
    $$('#tabela-itens tbody tr').forEach(tr=>{
      const codigo = tr.querySelector('.codigo').value.trim().toUpperCase();
      const descricao = tr.querySelector('.desc').value.trim();
      const idMaquina = (tr.querySelector('.idmaq').value||'').trim();
      const qtd = clamp(tr.querySelector('.qtd').value,1,9999);
      const valor = Math.max(0, Number(tr.querySelector('.valor').value)||0);
      if (descricao && qtd>0){ itens.push({codigo,descricao,idMaquina,qtd,valor,subtotal:qtd*valor}); }
    });
    return itens;
  }
  function calcTotal(){
    let subtotal = 0;
    $$('#tabela-itens tbody tr').forEach(tr=>{
      const q = clamp(tr.querySelector('.qtd').value,1,9999);
      const v = Math.max(0,Number(tr.querySelector('.valor').value)||0);
      const s = q*v; subtotal += s; tr.querySelector('.sub').textContent = BRL(s);
    });
    const descValor = Math.max(0, Number($('#desc-valor').value)||0);
    const frete = Math.max(0, Number($('#frete').value)||0);
    const total = Math.max(0, subtotal - descValor + frete);
    $('#subtotal').textContent = BRL(subtotal);
    $('#total-geral').textContent = BRL(total);
    return {subtotal,total,descValor,frete};
  }

  /* ========= Fluxo ========= */
  const FLUXO = ['Supervisor Diversey','Fornecedor','Rota de Entrega','Entregue'];
  function applyFlowStyle(selectEl, value){
    selectEl.classList.remove('flow-sup','flow-forn','flow-rota','flow-ent');
    if (value==='Supervisor Diversey') selectEl.classList.add('flow-sup');
    else if (value==='Fornecedor') selectEl.classList.add('flow-forn');
    else if (value==='Rota de Entrega') selectEl.classList.add('flow-rota');
    else if (value==='Entregue') selectEl.classList.add('flow-ent');
    else selectEl.classList.add('flow-sup');
  }
  function makeFlowSelect(value, disabled=false){
    const sel = document.createElement('select');
    sel.className = 'status'; sel.disabled = disabled;
    FLUXO.forEach(st=>{ const opt=document.createElement('option'); opt.value=st; opt.textContent=st; if(st===value) opt.selected=true; sel.appendChild(opt); });
    applyFlowStyle(sel, value||'Supervisor Diversey');
    sel.addEventListener('change', ()=>applyFlowStyle(sel, sel.value));
    return sel;
  }

  /* ========= Numeração ========= */
  function gerarNumeroLocal(){
    const d = new Date();
    const key = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
    let seq = JSON.parse(localStorage.getItem(LS.SEQ)||'{}');
    if (seq.date !== key){ seq = {date:key,counter:1}; }
    const numero = `REQ-${key}-${String(seq.counter).padStart(4,'0')}`;
    $('#req-num').value = numero;
    seq.counter++;
    localStorage.setItem(LS.SEQ, JSON.stringify(seq));
  }
  function proximoNumeroGlobal(){
    const d = new Date();
    const key = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
    const prefix = `REQ-${key}-`;
    const existentes = GLOBAL_CACHE.orders.filter(o => (o.numero||'').startsWith(prefix));
    let maior = 0;
    existentes.forEach(o=>{ const seq = Number((o.numero||'').slice(prefix.length)); if (Number.isFinite(seq) && seq>maior) maior = seq; });
    return `${prefix}${String(maior+1).padStart(4,'0')}`;
  }
  async function gerarNumero(){
    if (getModo()==='global'){
      const field = $('#req-num');
      field.value = 'Sincronizando OneDrive...';
      try { await ensureGlobalCache(); field.value = proximoNumeroGlobal(); }
      catch(e){ console.error(e); toast('Não foi possível ler os pedidos do OneDrive.'); field.value=''; }
    } else { gerarNumeroLocal(); }
  }

  /* ========= Histórico ========= */
  const byRecentFirst = (a,b) => (b.data || '').localeCompare(a.data || '') || (b.numero || '').localeCompare(a.numero || '');
  function bindSelectAll(){
    const master = document.getElementById('hist-select-all');
    if (!master) return;
    master.addEventListener('change', ()=>{
      document.querySelectorAll('#tabela-hist tbody input.hist-select').forEach(chk => { chk.checked = master.checked; });
    });
  }
  function btn(t,fn){ const b=document.createElement('button'); b.textContent=t; b.addEventListener('click',fn); return b; }

  function montarHistoricoLocal(){
    const tb = $('#tabela-hist tbody'); tb.innerHTML='';
    let lista = (JSON.parse(localStorage.getItem(LS.ORD)||'[]')||[]).map(normalizePedido);
    lista.sort(byRecentFirst);
    $('#hist-empty').style.display = lista.length ? 'none' : 'block';
    for (const o of lista){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center"><input type="checkbox" class="hist-select" value="${o.numero}"></td>
        <td class="td-num">${o.numero}</td>
        <td class="td-data">${o.data}</td>
        <td class="td-tec">${o.tecnico||'-'}</td>
        <td>${o.itens?.length||0}</td>
        <td>${BRL(o.total||0)}</td>
        <td></td>
        <td></td>`;
      const sel = makeFlowSelect(o.status||'Supervisor Diversey', false);
      sel.addEventListener('change',()=>{
        if (sel.value==='Entregue'){
          const ok = confirm('Confirmar entrega?');
          if (!ok){ sel.value = o.status||'Supervisor Diversey'; applyFlowStyle(sel, sel.value); return; }
        }
        let L = JSON.parse(localStorage.getItem(LS.ORD)||'[]');
        const i = L.findIndex(x=>x.numero===o.numero);
        if (i>=0){ L[i].status = sel.value; localStorage.setItem(LS.ORD, JSON.stringify(L)); toast('Fluxo atualizado: '+sel.value); }
      });
      tr.children[6].appendChild(sel);
      const tdA = tr.children[7];
      tdA.appendChild(btn('Abrir',()=>abrirLocal(o.numero)));
      tdA.appendChild(btn('📊 Excel',()=>exportXLSXFrom(o)));
      tdA.appendChild(btn('📄 PDF',()=>baixarPDFFrom(o)));
      tb.appendChild(tr);
    }
    bindSelectAll();
  }

  async function montarHistoricoGlobal({refresh=false}={}){
    const tb = $('#tabela-hist tbody'); tb.innerHTML='';
    try {
      await ensureGlobalCache(refresh);
      const lista = GLOBAL_CACHE.orders.map(o=>normalizePedido(o)).sort(byRecentFirst);
      $('#hist-empty').style.display = lista.length ? 'none' : 'block';
      for (const o of lista){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:center"><input type="checkbox" class="hist-select" value="${o.numero}"></td>
          <td class="td-num">${o.numero}</td>
          <td class="td-data">${o.data}</td>
          <td class="td-tec">${o.tecnico||'-'}</td>
          <td>${o.itens?.length||0}</td>
          <td>${BRL(o.total||0)}</td>
          <td></td>
          <td></td>`;
        const sel = makeFlowSelect(o.status||'Supervisor Diversey', false);
        sel.addEventListener('change', async()=>{
          const novo = sel.value;
          if (novo==='Entregue'){
            const ok = confirm('Confirmar entrega?');
            if (!ok){ sel.value = o.status||'Supervisor Diversey'; applyFlowStyle(sel, sel.value); return; }
          }
          try{
            await ensureGlobalCache();
            const lista2 = GLOBAL_CACHE.orders.map(x=>normalizePedido(x));
            const idx = lista2.findIndex(x=>x.numero===o.numero);
            if (idx<0) throw new Error('Pedido não encontrado');
            lista2[idx].status = novo;
            await salvarListaGlobal(lista2);
            toast('Fluxo atualizado no OneDrive: ' + novo);
          }catch(e){
            console.error(e);
            toast(e.message||'Falha ao atualizar no OneDrive');
            sel.value = o.status||'Supervisor Diversey';
            applyFlowStyle(sel, sel.value);
          }
        });
        tr.children[6].appendChild(sel);
        const tdA = tr.children[7];
        tdA.appendChild(btn('Abrir',()=>abrirGlobal(o.numero)));
        tdA.appendChild(btn('📊 Excel',()=>exportXLSXFrom(o)));
        tdA.appendChild(btn('📄 PDF',()=>baixarPDFFrom(o)));
        tb.appendChild(tr);
      }
      bindSelectAll();
    } catch(e){ console.error('Histórico OneDrive', e); toast(e.message||'Falha ao carregar histórico do OneDrive'); }
  }

  function abrirLocal(num){ const lista=JSON.parse(localStorage.getItem(LS.ORD)||'[]'); const o=lista.find(x=>x.numero===num); if(!o) return; preencherFormularioPedido(normalizePedido(o)); toast('Solicitação carregada'); }
  function abrirGlobal(num){ const o = GLOBAL_CACHE.orders.find(x=>x.numero===num); if(!o){ toast('Pedido não encontrado no OneDrive.'); return; } preencherFormularioPedido(o); toast('Solicitação carregada do OneDrive'); }

  /* ========= Excel/PDF ========= */
  function orderToAOA(o){
    const head=['Nº Solicitação','Data da Solicitação','Técnico','Código','ID Máquina','Qtd','Descrição','Valor Unitário','Subtotal'];
    const rows=(o.itens||[]).map(it=>[
      o.numero||'', o.data, o.tecnico||'-', it.codigo||'', (it.idMaquina||''), it.qtd, it.descricao, Number(it.valor||0), Number((it.qtd||0)*(it.valor||0))
    ]);
    return [head,...rows];
  }
  function exportXLSXFrom(o){
    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(orderToAOA(o));
    ws1['!cols']=[{wch:22},{wch:18},{wch:30},{wch:10},{wch:28},{wch:6},{wch:46},{wch:14},{wch:14}];
    XLSX.utils.book_append_sheet(wb,ws1,'Itens');

    const resumo = [
      ['Número', o.numero],
      ['Data', fmtData(o.data)],
      ['Técnico', o.tecnico],
      ['Endereço', `${o.endereco||''}${o.bairro? ', '+o.bairro:''}`],
      ['Município/UF', `${o.municipio||''} - ${o.uf||''}`],
      ['CEP', fmtCEP(o.cep||'')],
      ['Tipo de Envio', o.envio||'Normal'],
      ['Observações', o.obs||'-'],
      ['Subtotal', o.subtotal||0],
      ['Desconto (R$)', o.descValor||0],
      ['Frete (R$)', o.frete||0],
      ['TOTAL', o.total||0],
      ['Fluxo', o.status||'Supervisor Diversey']
    ];
    const ws2 = XLSX.utils.aoa_to_sheet(resumo);
    ws2['!cols']=[{wch:18},{wch:60}];
    XLSX.utils.book_append_sheet(wb,ws2,'Resumo');
    XLSX.writeFile(wb, `${o.numero||'SOLICITACAO'}.xlsx`);
    toast('Excel (.xlsx) gerado ✅');
  }
  function makeSafeFilename(s){ return (s||'').replace(/[\\\/:*?"<>|]+/g,'').trim() || 'SemTecnico'; }

  /* ====== Util PDF ====== */
  const PDF_BRAND = { primary: [6, 36, 63], accent: [13, 196, 166], zebra: [247, 249, 252], boxFill: [246, 248, 250], title: 'Solicitação de Peças e Componentes' };
  const BRL_FMT = (v) => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtData = s => s && /^\d{4}-\d{2}-\d{2}$/.test(s) ? `${s.slice(8,10)}/${s.slice(5,7)}/${s.slice(0,4)}` : s;
  const fmtCEP  = s => (s||'').replace(/\D/g,'').replace(/(\d{5})(\d{3}).*/, '$1-$2');

  /* ====== PDF ====== */
  async function baixarPDFFrom(o){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const M = 40, PAGE_W = doc.internal.pageSize.getWidth(), PAGE_H = doc.internal.pageSize.getHeight();
    const CONTENT_W = PAGE_W - M*2;

    // Cabeçalho (igual à imagem)
    const header = ()=>{
      const yBrand = 32, yTitle = 58;
      doc.setFillColor(...PDF_BRAND.accent);
      doc.rect(0, 0, PAGE_W, 6, 'F');

      // Marca em duas linhas
      doc.setFont('helvetica','bold'); doc.setTextColor(...PDF_BRAND.primary);
      doc.setFontSize(26);
      doc.text('Diversey', M, yBrand);
      doc.setTextColor(...PDF_BRAND.accent); doc.setFontSize(14);
      doc.text('A SOLENIS COMPANY', M, yBrand+16);

      // Título à direita
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(...PDF_BRAND.primary);
      doc.text(PDF_BRAND.title, PAGE_W - M, 44, { align:'right' });

      // Linha divisória
      doc.setDrawColor(220);
      doc.line(M, yTitle+2, PAGE_W - M, yTitle+2);
    };

    const footer = ()=>{
      const pages = doc.internal.getNumberOfPages();
      for(let i=1;i<=pages;i++){
        doc.setPage(i);
        doc.setFontSize(9); doc.setTextColor(100);
        const ts = new Date().toLocaleString('pt-BR');
        doc.text(`Gerado em: ${ts}`, M, PAGE_H - 18);
        doc.text(`Página ${i}/${pages}`, PAGE_W - M, PAGE_H - 18, { align:'right' });
      }
    };

    header();

    // Bloco de dados com duas colunas e "Cidade/UF" NA ESQUERDA (como pedido)
    let y = 78;
    const L = (label, val, x, w, yy)=>{
      doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(0);
      doc.text(label, x, yy);
      doc.setFont('helvetica','normal'); doc.text(String(val||'-'), x+w, yy, {maxWidth:260});
    };

    L('Número:', o.numero, M, 60, y);
    L('Data:', fmtData(o.data), M+320, 40, y);
    y += 14;

    L('Técnico:', o.tecnico, M, 60, y);
    L('Envio:', o.envio||'Normal', M+320, 40, y);
    y += 14;

    const endLinha = `${o.endereco||''}${o.bairro? ', '+o.bairro:''}`;
    L('Endereço:', endLinha, M, 60, y);
    L('CEP:', fmtCEP(o.cep||''), M+320, 40, y);
    y += 14;

    // <<<<<<<< Alinhado à ESQUERDA, como os demais
    L('Cidade/UF:', `${o.municipio||''} - ${o.uf||''}`, M, 60, y);

    if (o.obs){
      y += 16;
      doc.setFont('helvetica','bold'); doc.text('Observações:', M, y);
      doc.setFont('helvetica','normal');
      const obs = doc.splitTextToSize(String(o.obs), CONTENT_W);
      y += 12; doc.text(obs, M, y); y += obs.length*12;
    }

    // Tabela de itens (com dados!)
    const sumFixed = 70 + 130 + 40 + 70 + 80;
    const COL_DESC = Math.max(120, CONTENT_W - sumFixed);
    const mapped = (o.itens||[]).map(it=>({
      codigo: it.codigo||'',
      id: it.idMaquina||'',
      qtd: Number(it.qtd||0),
      desc: it.descricao||'',
      vunit: BRL_FMT(it.valor||0),
      sub: BRL_FMT((it.qtd||0)*(it.valor||0))
    }));
    const body = mapped.length ? mapped : [{codigo:'—', id:'—', qtd:'—', desc:'Sem itens', vunit:'—', sub:'—'}];

    doc.autoTable({
      startY: y + 16,
      margin: { left:M, right:M },
      tableWidth: CONTENT_W,
      theme:'grid',
      styles: { font:'helvetica', fontSize:9, cellPadding:{top:4,right:8,bottom:4,left:8}, overflow:'linebreak' },
      headStyles: { fillColor: PDF_BRAND.primary, textColor:255, fontStyle:'bold', fontSize:10 },
      bodyStyles: { valign:'top' },
      alternateRowStyles: { fillColor: PDF_BRAND.zebra },
      columns: [
        { header:'Código', dataKey:'codigo' },
        { header:'ID Máquina', dataKey:'id' },
        { header:'Qtd', dataKey:'qtd' },
        { header:'Descrição', dataKey:'desc' },
        { header:'Valor Unit.', dataKey:'vunit' },
        { header:'Subtotal', dataKey:'sub' }
      ],
      columnStyles: {
        codigo:{ cellWidth:70 },
        id:{ cellWidth:130 },
        qtd:{ cellWidth:40, halign:'center' },
        desc:{ cellWidth:COL_DESC, overflow:'linebreak' },
        vunit:{ cellWidth:70, halign:'right' },
        sub:{ cellWidth:80, halign:'right' }
      },
      body,
      didDrawPage: ()=>{ header(); }
    });

    const afterTableY = Math.max((doc.lastAutoTable && doc.lastAutoTable.finalY) || (y+30), y+120);

    // Quadro de totais — à DIREITA e valores alinhados à direita
    const boxW=230, boxX = M + CONTENT_W - boxW, boxY = afterTableY + 16;
    doc.setDrawColor(225); doc.setFillColor(...PDF_BRAND.boxFill);
    doc.roundedRect(boxX, boxY-12, boxW, 96, 6, 6, 'FD');

    const row = (label, val, yRow)=>{
      doc.setFont('helvetica','bold'); doc.text(label, boxX+12, yRow);
      doc.setFont('helvetica','normal'); doc.text(BRL_FMT(Number(val||0)), boxX+boxW-12, yRow, {align:'right'});
    };
    row('Subtotal', o.subtotal, boxY+6);
    row('Desconto (R$)', o.descValor, boxY+24);
    row('Frete (R$)', o.frete, boxY+42);
    doc.setDrawColor(210); doc.line(boxX+12, boxY+50, boxX+boxW-12, boxY+50);
    doc.setFont('helvetica','bold'); doc.text('TOTAL', boxX+12, boxY+68);
    doc.text(BRL_FMT(Number(o.total||0)), boxX+boxW-12, boxY+68, {align:'right' });

    // Fluxo
    doc.setFont('helvetica','normal');
    doc.text(`Fluxo: ${o.status||'Supervisor Diversey'}`, M, boxY+96+16);

    // Assinaturas
    const signY = PAGE_H - 80;
    doc.setDrawColor(160);
    doc.line(M, signY, M+220, signY); doc.text('Solicitante', M, signY+14);
    doc.line(M+260, signY, M+480, signY); doc.text('Recebido por', M+260, signY+14);

    footer();

    const blob = doc.output('blob');
    const safeTec = makeSafeFilename(o.tecnico);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${o.numero||'SOLICITACAO'} - ${safeTec}.pdf`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
    toast('PDF gerado ✅');
  }

  /* ========= Local / Global ========= */
  function getOrder(){
    const it = collectItems(), c = calcTotal();
    return {
      numero: $('#req-num').value,
      data: new Date().toISOString().slice(0,10),
      tecnico: $('#tecnico').value,
      endereco: $('#endereco').value,
      bairro: $('#bairro').value,
      municipio: $('#municipio').value,
      uf: $('#uf').value,
      cep: $('#cep').value,
      envio: $('#envio').value || 'Normal',
      obs: $('#obs').value,
      itens: it,
      subtotal: c.subtotal,
      total: c.total,
      descValor: c.descValor,
      frete: c.frete,
      status: 'Fornecedor'
    };
  }
  function exportXLSX(){ exportXLSXFrom(getOrder()); }
  async function baixarPDF(){ await baixarPDFFrom(getOrder()); }

  function preencherFormularioPedido(o){
    if (!o) return;
    $('#req-num').value = o.numero||'';
    $('#tecnico').value = o.tecnico||'';
    preencherEndereco(o.tecnico||'');
    $('#envio').value = o.envio||'Normal';
    $('#obs').value = o.obs||'';
    $('#desc-valor').value = o.descValor||0;
    $('#frete').value = o.frete||0;
    const tbody = $('#tabela-itens tbody');
    tbody.innerHTML = '';
    const itens = Array.isArray(o.itens) ? o.itens : [];
    if (itens.length){ itens.forEach(it=>addRow({ codigo:it.codigo, descricao:it.descricao, valor:it.valor, qtd:it.qtd, idMaquina:it.idMaquina })); }
    else { addRow(); }
    calcTotal();
  }

  function coletarPedidoDados(){
    const tecnico = $('#tecnico').value;
    if (!tecnico){ toast('Selecione o técnico'); return null; }
    const itens = collectItems();
    if (!itens.length){ toast('Inclua ao menos 1 item'); return null; }
    const tot = calcTotal();
    return normalizePedido({
      numero: $('#req-num').value || (getModo()==='global'?proximoNumeroGlobal():''),
      data: new Date().toISOString().slice(0,10),
      tecnico,
      endereco: $('#endereco').value,
      bairro: $('#bairro').value,
      municipio: $('#municipio').value,
      uf: $('#uf').value,
      cep: $('#cep').value,
      envio: $('#envio').value || 'Normal',
      obs: $('#obs').value,
      ...tot,
      itens
    });
  }

  function salvarLocal(){
    const dados = coletarPedidoDados();
    if (!dados) return false;
    const lista = JSON.parse(localStorage.getItem(LS.ORD)||'[]');
    const i = lista.findIndex(o=>o.numero===dados.numero);
    if (i>=0){ dados.status = lista[i].status || dados.status; lista[i] = dados; }
    else { lista.push(dados); }
    localStorage.setItem(LS.ORD, JSON.stringify(lista));
    localStorage.setItem(LS.CUR, JSON.stringify(dados));
    montarHistoricoLocal();
    return true;
  }
  async function salvarGlobal(){
    const dados = coletarPedidoDados();
    if (!dados) return false;
    try{
      await ensureGlobalCache();
      const lista = GLOBAL_CACHE.orders.map(o=>normalizePedido(o));
      const idx = lista.findIndex(o=>o.numero===dados.numero);
      if (idx>=0){ dados.status = lista[idx].status || dados.status; lista[idx] = dados; }
      else { lista.push(dados); }
      await salvarListaGlobal(lista);
      await montarHistoricoGlobal({refresh:false});
      localStorage.setItem(LS.CUR, JSON.stringify(dados));
      return true;
    }catch(e){ console.error('Salvar OneDrive', e); toast(e.message||'Falha ao salvar no OneDrive'); return false; }
  }
  async function salvarAtual(){ if (getModo()==='global') return await salvarGlobal(); return salvarLocal(); }

  /* ========= PWA em HTML Único (service worker inline) ========= */
  function installSW(){
    try{
      if (!('serviceWorker' in navigator)) return;
      const swCode = `
        self.addEventListener('install', (e)=>{ self.skipWaiting(); e.waitUntil(caches.open('sp-shell-v1').then(c=>c.addAll(['./']))); });
        self.addEventListener('activate', (e)=>self.clients.claim());
        self.addEventListener('fetch', (e)=>{
          if (e.request.method !== 'GET') return;
          e.respondWith(
            caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{
              const cp = resp.clone(); caches.open('sp-shell-v1').then(c=>c.put(e.request, cp)).catch(()=>{});
              return resp;
            }).catch(()=>r))
          );
        });`;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url);
    }catch(_){ /* silencioso */ }
  }

  /* ========= Boot ========= */
  function novaSolicitacao(){
    $('#tecnico').value=''; $('#endereco').value=''; $('#bairro').value=''; $('#municipio').value=''; $('#uf').value=''; $('#cep').value='';
    $('#envio').value='Normal'; $('#obs').value=''; $('#desc-valor').value=0; $('#frete').value=0;
    $('#tabela-itens tbody').innerHTML=''; gerarNumero(); addRow();
  }
  function abrirModalOneDrive(){
    const cfg = OneDriveStore.getConfig();
    $('#onedrive-share').value = cfg.shareUrl||'';
    $('#onedrive-token').value = cfg.accessToken||'';
    $('#onedrive-refresh-min').value = cfg.refreshMinutes||GLOBAL_REFRESH_MIN_DEFAULT;
    $('#onedrive-arquivo').value = cfg.fileName||'pedidos.json';
    $('#modal-onedrive').style.display='flex';
  }
  function fecharModalOneDrive(){ $('#modal-onedrive').style.display='none'; }
  async function salvarConfiguracaoOneDrive(){
    try{
      const cfg = OneDriveStore.setConfig({
        shareUrl: $('#onedrive-share').value.trim(),
        accessToken: $('#onedrive-token').value.trim(),
        refreshMinutes: Number($('#onedrive-refresh-min').value||GLOBAL_REFRESH_MIN_DEFAULT),
        fileName: $('#onedrive-arquivo').value.trim()||'pedidos.json'
      });
      toast('Configuração do OneDrive salva ✅');
      fecharModalOneDrive();
      if (getModo()==='global' && cfg.shareUrl && cfg.accessToken){
        await montarHistoricoGlobal({refresh:true});
        gerarNumero();
      }
    }catch(e){ console.error('Salvar config OneDrive', e); toast(e.message||'Não foi possível salvar a configuração do OneDrive'); }
  }
  async function testarConfiguracaoOneDrive(){
    try{
      await OneDriveStore.testConfig({
        shareUrl: $('#onedrive-share').value.trim(),
        accessToken: $('#onedrive-token').value.trim(),
        refreshMinutes: GLOBAL_REFRESH_MIN_DEFAULT,
        fileName: $('#onedrive-arquivo').value.trim()||'pedidos.json'
      });
    toast('Conexão com OneDrive validada ✅');
    }catch(e){ console.error('Teste config OneDrive', e); toast(e.message||'Falha ao testar conexão com OneDrive'); }
  }

  function boot(){
    if (!localStorage.getItem(LS.ONEDRIVE)) { OneDriveStore.setConfig(DEFAULT_ONEDRIVE); }
    if (!localStorage.getItem(LS.MODO)) localStorage.setItem(LS.MODO,'global');

    $('#btn-modo-local').addEventListener('click',()=>setModo('local'));
    $('#btn-modo-global').addEventListener('click',()=>setModo('global'));
    $('#btn-onedrive-config').addEventListener('click',abrirModalOneDrive);
    $('#btn-global-sync').addEventListener('click',async()=>{
      if (getModo()!=='global'){ toast('Ative o modo GLOBAL para sincronizar com o OneDrive.'); return; }
      try{ await montarHistoricoGlobal({refresh:true}); gerarNumero(); toast('OneDrive sincronizado ☁️'); }
      catch(e){ console.error('Sync OneDrive', e); toast(e.message||'Falha ao sincronizar com OneDrive'); }
    });

    $('#btn-pdf').addEventListener('click',baixarPDF);
    $('#btn-xlsx').addEventListener('click',exportXLSX);
    $('#btn-enviar').addEventListener('click', async ()=>{
      const ok = await salvarAtual();
      if (ok){
        toast('Enviado com sucesso. Pedido foi para o histórico.');
        const hc = document.getElementById('hist-content'); if (hc) hc.style.display='';
        document.getElementById('hist').scrollIntoView({behavior:'smooth'});
        novaSolicitacao();
      }
    });

    $('#onedrive-cancelar').addEventListener('click',fecharModalOneDrive);
    $('#onedrive-salvar').addEventListener('click',salvarConfiguracaoOneDrive);
    $('#onedrive-testar').addEventListener('click',testarConfiguracaoOneDrive);

    const histContent = document.getElementById('hist-content');
    document.getElementById('btn-hist-mostrar').addEventListener('click',()=>{ histContent.style.display=''; });
    document.getElementById('btn-hist-ocultar').addEventListener('click',()=>{ histContent.style.display='none'; });
    $('#btn-hist').addEventListener('click',async()=>{ if (getModo()==='global') await montarHistoricoGlobal({refresh:true}); else montarHistoricoLocal(); });

    document.getElementById('hist-del').addEventListener('click', async ()=>{
      const numeros = [...document.querySelectorAll('#tabela-hist tbody input.hist-select:checked')].map(chk=>chk.value).filter(Boolean);
      if (!numeros.length){ toast('Nenhum pedido selecionado'); return; }
      const ok = confirm(`Excluir ${numeros.length} pedido(s)?`);
      if (!ok) return;
      if (getModo()==='global'){
        try{
          await ensureGlobalCache();
          const lista = GLOBAL_CACHE.orders.filter(o=>!numeros.includes(o.numero));
          await salvarListaGlobal(lista);
          toast('Removido(s) do OneDrive');
          await montarHistoricoGlobal({refresh:true});
        }catch(e){ console.error(e); toast(e.message||'Falha ao excluir no OneDrive'); }
      } else {
        let lista = JSON.parse(localStorage.getItem(LS.ORD) || '[]');
        const antes = lista.length;
        lista = lista.filter(o => !numeros.includes(o.numero));
        localStorage.setItem(LS.ORD, JSON.stringify(lista));
        const cur = JSON.parse(localStorage.getItem(LS.CUR) || 'null');
        if (cur && numeros.includes(cur.numero)){ localStorage.removeItem(LS.CUR); }
        toast(`Removido(s): ${antes - lista.length}`);
        montarHistoricoLocal();
      }
    });

    preencherListas();
    $('#tecnico').addEventListener('input',()=>preencherEndereco($('#tecnico').value));
    $('#add-item').addEventListener('click',()=>addRow());

    document.addEventListener('keydown', (ev)=>{
      if (ev.ctrlKey && ev.key === 'Enter'){ ev.preventDefault(); addRow(); }
      if (ev.ctrlKey && (ev.key.toLowerCase() === 'e')){ ev.preventDefault(); $('#btn-enviar').click(); }
    });

    $('#badge-modo').textContent='Modo: '+getModo().toUpperCase();
    novaSolicitacao();
    if (getModo()==='global') montarHistoricoGlobal({refresh:true}); else montarHistoricoLocal();
    installSW();
  }

  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot); }
  else { boot(); }
  </script>
</body>
</html>
