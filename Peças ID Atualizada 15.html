<!-- index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solicitação de Peças — Diversey (A Solenis Company)</title>

<!-- jsPDF + AutoTable (PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<!-- XLSX (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0f172a;--panel:#1e293b;--header:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--accent:#10b981;
  --border:#334155;--danger:#ef4444;--shadow:0 6px 24px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{
  display:flex;justify-content:space-between;align-items:center;gap:16px;
  padding:14px 22px;background:var(--header);border-bottom:2px solid var(--accent);
  position:sticky;top:0;z-index:5
}
.brand{display:flex;flex-direction:column;line-height:1.15}
.brand .line1{font-weight:800;font-size:22px;color:#fff}
.brand .line2{font-weight:600;font-size:12px;color:var(--accent);letter-spacing:.4px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button{
  background:#121a2a;border:1px solid var(--border);color:var(--text);
  border-radius:10px;padding:8px 12px;cursor:pointer;transition:.2s
}
button:hover{background:var(--accent);color:#06121a;border-color:var(--accent)}
.btn-primary{background:var(--accent);color:#062015;border-color:transparent}
.btn-danger{background:var(--danger);border:none;color:#fff}
.ghost{background:#0f172a}
main{max-width:min(1280px,92vw);margin:28px auto;padding:0 18px}
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:14px;
  padding:16px 18px;margin-bottom:16px;box-shadow:var(--shadow)
}
h2{margin:0 0 12px 0;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
label{font-size:13px;color:var(--muted);display:block}
input,select,textarea{
  width:100%;margin-top:6px;padding:9px 10px;border-radius:10px;
  background:#0f172a;border:1px solid var(--border);color:var(--text)
}
input[readonly]{opacity:.9}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:8px 6px;text-align:left;vertical-align:middle}
th{background:#0f172a;color:#10b981;position:sticky;top:72px;z-index:2}
tr:nth-child(even){background:#1f2e44}
tr:hover{background:#263956}
.right{text-align:right}
.actions-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:12px}
.totais{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.totais input{width:130px;text-align:right}
.small{font-size:12px;color:var(--muted);margin-top:8px}
.badge{
  border:1px solid var(--border);border-radius:999px;padding:4px 10px;
  color:var(--muted);font-size:12px;background:rgba(255,255,255,.04);margin-left:8px
}
.toast{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
  background:var(--panel);border:1px solid var(--border);padding:10px 14px;
  border-radius:12px;box-shadow:var(--shadow);display:none;z-index:99
}
.toast.show{display:block}
.hist-header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.count{color:var(--muted);font-size:12px}
select.status{
  width:auto;min-width:160px;border:none;color:#fff;font-weight:600;border-radius:8px;padding:6px 8px
}
.flow-sup{background:#f59e0b}
.flow-forn{background:#06b6d4}
.flow-rota{background:#8b5cf6}
.flow-ent{background:#22c55e}
#tabela-hist th, #tabela-hist td{font-size:12px}
#tabela-hist td:last-child{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <div class="brand">
      <span class="line1">Diversey</span>
      <span class="line2">A Solenis Company</span>
    </div>
    <span id="badge-api" class="badge">WebApp: não configurado</span>
  </div>
  <div class="toolbar">
    <button id="btn-config-api" class="ghost">Configurar WebApp</button>
    <button id="btn-excel" class="ghost">Excel</button>
    <button id="btn-pdf" class="ghost">PDF</button>
    <button id="btn-enviar" class="btn-primary">Enviar</button>
    <button id="btn-limpar" class="ghost">Limpar</button>
  </div>
</header>

<main>
  <!-- DADOS -->
  <section class="card">
    <h2>Dados da Solicitação</h2>
    <div class="grid">
      <div>
        <label>Nº Solicitação
          <input id="req-num" readonly>
        </label>
        <label>Técnico
          <input id="tecnico" list="tecnicos" placeholder="Selecione o técnico">
          <datalist id="tecnicos"></datalist>
        </label>
        <label>Endereço
          <input id="endereco" readonly>
        </label>
        <label>Cidade / UF
          <input id="cidadeuf" readonly>
        </label>
      </div>
      <div>
        <label>Data
          <input id="data" type="date">
        </label>
        <label>Tipo de Envio
          <select id="envio">
            <option value="Normal" selected>Normal</option>
            <option value="Sedex">Sedex</option>
            <option value="Urgente">Urgente</option>
          </select>
        </label>
        <label>CEP
          <input id="cep" readonly>
        </label>
        <label>Observações
          <textarea id="obs" rows="2" placeholder="Observações adicionais..."></textarea>
        </label>
      </div>
    </div>
    <div class="small">Formulário local, integrado ao Apps Script (planilha apenas como banco de dados).</div>
  </section>

  <!-- ITENS -->
  <section class="card">
    <h2>Itens da Solicitação</h2>
    <datalist id="pecas"></datalist>
    <table id="tbl-itens">
      <thead>
        <tr>
          <th style="width:110px">Código</th>
          <th style="width:200px">ID Máquina</th>
          <th style="width:70px">Qtd</th>
          <th>Descrição</th>
          <th style="width:130px" class="right">Valor Unit.</th>
          <th style="width:140px" class="right">Subtotal</th>
          <th style="width:140px">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="actions-row">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btn-add" class="btn-primary">Adicionar Item</button>
        <button id="btn-add-blank" class="ghost">Linha em branco</button>
      </div>
      <div class="totais">
        <span id="itens-count" class="badge">0 itens</span>
        <span>Subtotal:</span> <strong id="subtotal">R$ 0,00</strong>
        <span>Desconto (R$):</span> <input id="desc-valor" type="number" step="0.01" value="0">
        <span>Frete (R$):</span> <input id="frete" type="number" step="0.01" value="0">
        <span>Total:</span> <strong id="total-geral">R$ 0,00</strong>
      </div>
    </div>
  </section>

  <!-- HISTÓRICO -->
  <section class="card">
    <div class="hist-header">
      <h2 style="margin:0">Histórico <span class="count" id="hist-count"></span></h2>
      <div class="toolbar">
        <button id="btn-hist-atualizar" class="ghost">Atualizar</button>
        <button id="btn-hist-excluir" class="btn-danger">Excluir selecionados</button>
      </div>
    </div>
    <table id="tabela-hist">
      <thead>
        <tr>
          <th style="width:36px;text-align:center"><input id="hist-select-all" type="checkbox"></th>
          <th>Nº</th>
          <th>Data</th>
          <th>Técnico</th>
          <th>Itens</th>
          <th>Total</th>
          <th>Fluxo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
'use strict';

/* ======== UTILS ======== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const BRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

function showToast(msg, ms=2500){
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

/* ======== CONFIG WEBAPP ======== */
let API_URL = '';

function carregarApiUrl(){
  API_URL = localStorage.getItem('webappUrl') || '';
  if(!API_URL){
    const u = prompt('Informe a URL do WebApp (termina com /exec)');
    if(u){
      API_URL = u.trim();
      localStorage.setItem('webappUrl', API_URL);
    }
  }
  atualizarBadgeApi();
}

function atualizarBadgeApi(){
  const b = $('#badge-api');
  if(!API_URL){
    b.textContent = 'WebApp: não configurado';
  }else{
    b.textContent = 'WebApp: configurado';
  }
}

async function api(rota, payload){
  if(!API_URL){
    showToast('Configure a URL do WebApp primeiro.');
    throw new Error('WebApp não configurado');
  }
  const resp = await fetch(API_URL, {
    method:'POST',
    headers: {"Content-Type": "application/json"}, // CORREÇÃO AQUI
    body:JSON.stringify(Object.assign({rota}, payload || {}))
  });
  let data;
  try{
    data = await resp.json();
  }catch(e){
    showToast('Resposta inválida do servidor.');
    throw e;
  }
  if(!data.ok){
    showToast(data.msg || 'Erro no servidor.');
    throw new Error(data.msg || 'Erro');
  }
  return data;
}

/* ======== BASE DE DADOS LOCAL (TÉCNICOS E PEÇAS) ======== */
const tecnicosBase = {
"Antonio Ferreira De Santana Filho": {"endereco": "Av Curió - Campanário, Ap 510 Bloco B", "bairro": "", "cep": "09.925-000", "municipio": "Diadema", "uf": "SP"},
"Antonio Rocker": {"endereco": "Rua Estoril 131", "bairro": "Veleiros", "cep": "47.730-900", "municipio": "São Paulo", "uf": "SP"},
"Brunno Diniz Mendes": {"endereco": "Rua da Granja S/N, Condomínio Plaza Norte Residence, Bloco 06C AP 010", "bairro": "Maiobinha", "cep": "65120-176", "municipio": "São José de Ribamar", "uf": "MA"},
"Carlos Alberto De Vasconcelos Junior": {"endereco": "Deputado João Ursulo Ribeiro Filho A 149", "bairro": "Mangabeira I", "cep": "58.055-360", "municipio": "João Pessoa", "uf": "PB"},
"Dalvino Carlos Santos Junior": {"endereco": "Rua vivaldo sales 158, apartamento 41", "bairro": "jardim são josé", "cep": "11-430 140", "municipio": "guarujá são paulo", "uf": "SP"},
"Davidson Alves Vitorino": {"endereco": "Jacarandá N° 157", "bairro": "Sapucaias 3", "cep": "32.071-236", "municipio": "Contagem", "uf": "MG"},
"Diego Abner de Oliveira": {"endereco": "Rua Mário Campos 71 AP 401 Bloco 08", "bairro": "", "cep": "12.221-750", "municipio": "São Jose do Campos", "uf": "SP"},
"Ednaldo Silva Costa": {"endereco": "Rua Olimpío Cassimiro Mendonça, 542", "bairro": "Parque das Américas", "cep": "38.045-360", "municipio": "Uberaba", "uf": "MG"},
"Ediveton Pedro Da Silva": {"endereco": "Rua Mário Prieto 500", "bairro": "Jardim Paulista", "cep": "13.310-000", "municipio": "Itu", "uf": "SP"},
"Eduardo Martins": {"endereco": "Rua Rafael da Silva e Souza N°510", "bairro": "Cidade Líder", "cep": "08280-090", "municipio": "São Paulo", "uf": "SP"},
"Emerson Ribeiro": {"endereco": "Rua São Cristóvão, 471 Casa 03", "bairro": "", "cep": "88.080-320", "municipio": "Florianópolis", "uf": "SC"},
"Fernando Silva": {"endereco": "Hermelindo Lazarini, 69", "bairro": "Jardim das Nações", "cep": "79.081-714", "municipio": "Campo Grande", "uf": "MS"},
"Getulio Santos De Almeida": {"endereco": "Rua Nara Leão, N° 125. Apto Jarmim 1103", "bairro": "Jardim Limoeiro", "cep": "29.164-125", "municipio": "Serra", "uf": "ES"},
"Humberto Elias Dos Santos Da Silva": {"endereco": "Av Jose Aloisio Filho N° 411 Apto 368 Bloco Q", "bairro": "Humaita", "cep": "90.250-180", "municipio": "Porto Alegre", "uf": "RS"},
"Joao Celso Silva De Souza": {"endereco": "Leonardo da Vinci 96 Bloco C Ap 306", "bairro": "Curado II", "cep": "54.220-000", "municipio": "Jaboatão dos Guararapes", "uf": "PE"},
"Leandro Rocha Cruz": {"endereco": "R. Dom Pedro II 537A Fundos", "bairro": "Centro", "cep": "14.820-290", "municipio": "Cidade Américo Brasiliense - SP", "uf": "SP"},
"Maicon Cordeiro Chaves": {"endereco": "Rua Saxonia N°2013", "bairro": "Vila Itoupava", "cep": "89075-255", "municipio": "Blumenau", "uf": "SC"},
"Marcio Andrade Dos Santos": {"endereco": "1° Travessa Renato Lima de Carvalho N° 33", "bairro": "Jardim Alvorada", "cep": "42.850-000", "municipio": "Dias davila", "uf": "BA"},
"Marlon de Queiroz": {"endereco": "AV. Juscelino Kubitschek, 3700 Bloco-E, Apto -301", "bairro": "Passare", "cep": "60.861.634", "municipio": "Fortaleza", "uf": "CE"},
"Ney Goncalves Cardoso": {"endereco": "Rua Juqueri,266", "bairro": "Irajá", "cep": "21.371-370", "municipio": "Rio de Janeiro", "uf": "RJ"},
"Pedro Gabriel Reis Nunes": {"endereco": "Rua Cristo Rei, 230, casa 101.", "bairro": "São José", "cep": "97095-680", "municipio": "Santa Maria", "uf": "RS"},
"Rodrigo Lazari De Carvalho": {"endereco": "Rua alonso Vasconcelos pacheco 1327", "bairro": "", "cep": "09310-695", "municipio": "Maua", "uf": "SP"},
"Sebastião Gomes Ribeiro": {"endereco": "RUA THOME DE SOUZA, 335", "bairro": "LAGOA GRANDE – SEDE", "cep": "45.810-000", "municipio": "PORTO SEGURO", "uf": "BA"},
"Welington Bastos Tavares": {"endereco": "AV Morumbi Qd 34 Lt 11", "bairro": "Vila Mariana", "cep": "75.134-550", "municipio": "Anápolis", "uf": "GO"},
"Werverton Santos": {"endereco": "Rua Constância da Conceição 04", "bairro": "Vila Jaguari", "cep": "05126-2090", "municipio": "São Paulo", "uf": "SP"}
};

const itensBase = [
{"codigo":"CS001","descricao":"Adaptador Braço Lavagem HD-80","valor":225.00},
{"codigo":"CS002","descricao":"Adaptador Do Braço De Lavagem (Tarugo) HD-50","valor":175.70},
{"codigo":"CS003","descricao":"Adaptador Do Braço De Lavagem (Tarugo) HD-80","valor":205.00},
{"codigo":"CS004","descricao":"Adaptador Interno HD-80","valor":350.00},
{"codigo":"CS005","descricao":"Arruela De Rotação HD-80","valor":40.00},
{"codigo":"CS006","descricao":"Assento Do Braço De Lavagem (Bucha) HD-50","valor":101.00},
{"codigo":"CS007","descricao":"Batente Lateral HD-80","valor":105.00},
{"codigo":"CS008","descricao":"Bicos Injetores Do Braço HD-50/HD-80","valor":114.48},
{"codigo":"CS009","descricao":"Boiler HD-50","valor":2033.00},
{"codigo":"CS010","descricao":"Boiler HD-80","valor":2355.00},
{"codigo":"CS124","descricao":"Conj Botao Emergencia c/ Bloco Cont e Colar Prot","valor":464.06}
];

/* ======== DATALISTS ======== */
function preencherTecnicos(){
  const dl = $('#tecnicos');
  dl.innerHTML = '';
  Object.keys(tecnicosBase).sort().forEach(nome=>{
    const opt = document.createElement('option');
    opt.value = nome;
    dl.appendChild(opt);
  });
}

function preencherPecas(){
  const dl = $('#pecas');
  dl.innerHTML = '';
  itensBase.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.codigo;
    opt.label = `${p.codigo} — ${p.descricao} — ${BRL(p.valor)}`;
    dl.appendChild(opt);
  });
}

function preencherEndereco(nome){
  const d = tecnicosBase[nome];
  if(!d) return;
  $('#endereco').value = d.endereco + (d.bairro ? ', ' + d.bairro : '');
  $('#cidadeuf').value = d.municipio + ' / ' + d.uf;
  $('#cep').value = d.cep;
}

/* ======== ITENS NA TABELA ======== */
function procurarPeca(codOuDesc){
  const s = (codOuDesc||'').toString().toLowerCase();
  if(!s) return null;
  let p = itensBase.find(x=>x.codigo.toLowerCase()===s);
  if(p) return p;
  return itensBase.find(x=>x.descricao.toLowerCase().includes(s)) || null;
}

function adicionarLinha(pref){
  const tb = $('#tbl-itens tbody');
  const tr = document.createElement('tr');
  const dados = pref || {};
  tr.innerHTML = `
    <td><input class="codigo" list="pecas" value="${dados.codigo||''}"></td>
    <td><input class="idmaq"  value="${dados.idMaquina||''}"></td>
    <td><input class="qtd" type="number" min="1" value="${dados.qtd||1}"></td>
    <td><input class="desc" value="${dados.descricao||''}"></td>
    <td><input class="valor right" type="number" step="0.01" min="0" value="${dados.valor||0}"></td>
    <td class="sub right">R$ 0,00</td>
    <td>
      <button class="ghost btn-dup">Duplicar</button>
      <button class="btn-danger btn-del">Excluir</button>
    </td>
  `;
  tb.appendChild(tr);

  const iCod = tr.querySelector('.codigo');
  const iDesc = tr.querySelector('.desc');
  const iQtd = tr.querySelector('.qtd');
  const iVal = tr.querySelector('.valor');

  function preencherPeloCadastro(p){
    if(!p) return;
    iCod.value = p.codigo;
    iDesc.value = p.descricao;
    iVal.value = p.valor;
    calcularTotais();
  }

  iCod.addEventListener('change',()=>preencherPeloCadastro(procurarPeca(iCod.value)));
  iDesc.addEventListener('change',()=>preencherPeloCadastro(procurarPeca(iDesc.value)));
  iQtd.addEventListener('input',()=>{ if(iQtd.value<=0) iQtd.value=1; calcularTotais(); });
  iVal.addEventListener('input',()=>{ if(iVal.value<0) iVal.value=0; calcularTotais(); });

  tr.querySelector('.btn-del').addEventListener('click',()=>{ tr.remove(); calcularTotais(); });
  tr.querySelector('.btn-dup').addEventListener('click',()=>{
    const item = coletarItensDaLinha(tr);
    adicionarLinha(item);
  });

  if(dados.codigo){
    const p = procurarPeca(dados.codigo);
    if(p) preencherPeloCadastro(p);
  }
  calcularTotais();
}

function coletarItensDaLinha(tr){
  const codigo = tr.querySelector('.codigo').value.trim().toUpperCase();
  const idMaquina = tr.querySelector('.idmaq').value.trim();
  const qtd = Math.max(1, Number(tr.querySelector('.qtd').value)||1);
  const descricao = tr.querySelector('.desc').value.trim();
  const valor = Math.max(0, Number(tr.querySelector('.valor').value)||0);
  const subtotal = qtd * valor;
  return {codigo,idMaquina,qtd,descricao,valor,subtotal};
}

function coletarItens(){
  const itens = [];
  $$('#tbl-itens tbody tr').forEach(tr=>{
    const it = coletarItensDaLinha(tr);
    if(it.descricao || it.codigo){
      itens.push(it);
    }
  });
  return itens;
}

function calcularTotais(){
  let subtotal = 0;
  let countItens = 0;
  $$('#tbl-itens tbody tr').forEach(tr=>{
    const it = coletarItensDaLinha(tr);
    subtotal += it.subtotal;
    if(it.descricao || it.codigo) countItens++;
    tr.querySelector('.sub').textContent = BRL(it.subtotal);
  });
  const desc = Math.max(0, Number($('#desc-valor').value)||0);
  const frete = Math.max(0, Number($('#frete').value)||0);
  const total = Math.max(0, subtotal - desc + frete);
  $('#subtotal').textContent = BRL(subtotal);
  $('#total-geral').textContent = BRL(total);
  $('#itens-count').textContent = `${countItens} ${countItens===1?'item':'itens'}`;
  return {subtotal, descValor:desc, frete, total};
}

/* ======== MONTAR OBJETO DE PEDIDO ======== */
function montarPedido(){
  const tecnico = $('#tecnico').value.trim();
  if(!tecnico){
    showToast('Informe o técnico.');
    return null;
  }
  const itens = coletarItens();
  if(!itens.length){
    showToast('Inclua ao menos 1 item.');
    return null;
  }
  const totals = calcularTotais();
  const [municipio='', uf=''] = ($('#cidadeuf').value || ' / ').split('/').map(s=>s.trim());
  return {
    numero: $('#req-num').value,
    tecnico,
    endereco: $('#endereco').value,
    cidadeUF: $('#cidadeuf').value,
    municipio, uf,
    cep: $('#cep').value,
    data: $('#data').value || new Date().toISOString().slice(0,10),
    envio: $('#envio').value,
    obs: $('#obs').value,
    subtotal: totals.subtotal,
    desconto: totals.descValor,
    frete: totals.frete,
    total: totals.total,
    fluxo: 'Supervisor Diversey',
    itens
  };
}

/* ======== PDF & EXCEL (USANDO OBJETO PEDIDO) ======== */
function exportarExcel(pedido){
  const wb = XLSX.utils.book_new();
  const cab = [
    ['Número', pedido.numero || ''],
    ['Data', pedido.data || ''],
    ['Técnico', pedido.tecnico || ''],
    ['Endereço', pedido.endereco || ''],
    ['Cidade/UF', pedido.cidadeUF || ''],
    ['CEP', pedido.cep || ''],
    ['Envio', pedido.envio || ''],
    ['Observações', pedido.obs || '']
  ];
  const wsCab = XLSX.utils.aoa_to_sheet(cab);
  XLSX.utils.book_append_sheet(wb, wsCab, 'Cabeçalho');

  const itens = [['Código','ID Máquina','Qtd','Descrição','Valor Unit.','Subtotal']];
  (pedido.itens||[]).forEach(it=>{
    itens.push([it.codigo,it.idMaquina,it.qtd,it.descricao,it.valor,it.subtotal]);
  });
  const wsItens = XLSX.utils.aoa_to_sheet(itens);
  XLSX.utils.book_append_sheet(wb, wsItens, 'Itens');

  const tot = [
    ['Subtotal', pedido.subtotal],
    ['Desconto (R$)', pedido.desconto],
    ['Frete (R$)', pedido.frete],
    ['TOTAL', pedido.total]
  ];
  const wsTot = XLSX.utils.aoa_to_sheet(tot);
  XLSX.utils.book_append_sheet(wb, wsTot, 'Totais');

  const safeTec = (pedido.tecnico||'').replace(/[\\\/:*?"<>|]+/g,'') || 'SemTecnico';
  XLSX.writeFile(wb, `${pedido.numero || 'REQ'}-${safeTec}.xlsx`);
}

async function exportarPDF(pedido){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const M = 40;
  const PAGE_W = doc.internal.pageSize.getWidth();
  const PAGE_H = doc.internal.pageSize.getHeight();
  const CONTENT_W = PAGE_W - 2*M;

  function header(){
    doc.setFillColor(16,185,129);
    doc.rect(0,0,PAGE_W,3,'F');
    doc.setFont('helvetica','bold');
    doc.setFontSize(18);
    doc.setTextColor(255,255,255);
    doc.text('Diversey',M,20);
    doc.setFontSize(11);
    doc.text('A Solenis Company',M,35);
    doc.setFontSize(14);
    doc.text('Solicitação de Peças',M,55);
  }
  header();
  let y = 80;
  doc.setFontSize(10);
  doc.setTextColor(0);
  doc.text(`Número: ${pedido.numero}`,M,y); y+=14;
  doc.text(`Data: ${pedido.data}`,M,y); y+=14;
  doc.text(`Técnico: ${pedido.tecnico}`,M,y); y+=14;
  doc.text(`Endereço: ${pedido.endereco}`,M,y); y+=14;
  doc.text(`Cidade/UF: ${pedido.cidadeUF}`,M,y); y+=14;
  doc.text(`CEP: ${pedido.cep}`,M,y); y+=18;
  if((pedido.obs||'').trim()){
    doc.text('Observações:',M,y); y+=12;
    doc.text(String(pedido.obs),M,y,{maxWidth:CONTENT_W}); y+=24;
  }

  const body = (pedido.itens||[]).map(it=>[
    it.codigo,
    it.idMaquina,
    it.qtd,
    it.descricao,
    BRL(it.valor),
    BRL(it.subtotal)
  ]);
  doc.autoTable({
    head:[['Código','ID Máquina','Qtd','Descrição','Valor Unit.','Subtotal']],
    body: body.length? body : [['-','-','-','Sem itens','-','-']],
    startY:y,
    margin:{left:M,right:M},
    styles:{fontSize:9,cellPadding:3},
    headStyles:{fillColor:[15,23,42],textColor:255}
  });
  let fy = doc.lastAutoTable.finalY + 18;
  if(fy + 80 > PAGE_H){
    doc.addPage();
    header();
    fy = 80;
  }
  doc.text(`Subtotal: ${BRL(pedido.subtotal)}`,M,fy); fy+=14;
  doc.text(`Desconto (R$): ${BRL(pedido.desconto)}`,M,fy); fy+=14;
  doc.text(`Frete (R$): ${BRL(pedido.frete)}`,M,fy); fy+=14;
  doc.setFont('helvetica','bold');
  doc.text(`TOTAL: ${BRL(pedido.total)}`,M,fy);

  const blob = doc.output('blob');
  const safeTec = (pedido.tecnico||'').replace(/[\\\/:*?"<>|]+/g,'') || 'SemTecnico';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${pedido.numero || 'REQ'}-${safeTec}.pdf`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ======== HISTÓRICO (COM BACKEND) ======== */
let HIST = [];

function aplicarClasseFluxo(sel, fluxo){
  sel.classList.remove('flow-sup','flow-forn','flow-rota','flow-ent');
  if(fluxo === 'Fornecedor') sel.classList.add('flow-forn');
  else if(fluxo === 'Rota de Entrega') sel.classList.add('flow-rota');
  else if(fluxo === 'Entregue') sel.classList.add('flow-ent');
  else sel.classList.add('flow-sup');
}

function renderHistorico(){
  const tb = $('#tabela-hist tbody');
  tb.innerHTML = '';
  HIST.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center"><input type="checkbox" class="hist-select" data-num="${p.numero}"></td>
      <td>${p.numero}</td>
      <td>${p.data}</td>
      <td>${p.tecnico||'-'}</td>
      <td>${p.qtItens||0}</td>
      <td>${BRL(p.total||0)}</td>
      <td></td>
      <td></td>
    `;
    const sel = document.createElement('select');
    sel.className = 'status';
    ['Supervisor Diversey','Fornecedor','Rota de Entrega','Entregue'].forEach(st=>{
      const opt = document.createElement('option');
      opt.value = st;
      opt.textContent = st;
      if((p.fluxo||'Supervisor Diversey') === st) opt.selected = true;
      sel.appendChild(opt);
    });
    aplicarClasseFluxo(sel, sel.value);
    sel.addEventListener('change', async ()=>{
      try{
        await api('atualizarFluxo',{numeros:[p.numero], fluxo:sel.value});
        aplicarClasseFluxo(sel, sel.value);
        p.fluxo = sel.value;
        showToast('Fluxo atualizado.');
      }catch(e){
        sel.value = p.fluxo || 'Supervisor Diversey';
        aplicarClasseFluxo(sel, sel.value);
      }
    });
    tr.children[6].appendChild(sel);

    const tdAcoes = tr.children[7];
    const bAbrir = document.createElement('button');
    bAbrir.textContent = 'Abrir';
    bAbrir.addEventListener('click',()=>abrirPedido(p.numero));
    const bDup = document.createElement('button');
    bDup.textContent = 'Duplicar';
    bDup.addEventListener('click',()=>duplicarPedido(p.numero));
    const bX = document.createElement('button');
    bX.textContent = 'Excel';
    bX.addEventListener('click',()=>exportarExcel(p));
    const bP = document.createElement('button');
    bP.textContent = 'PDF';
    bP.addEventListener('click',()=>exportarPDF(p));
    tdAcoes.appendChild(bAbrir);
    tdAcoes.appendChild(bDup);
    tdAcoes.appendChild(bX);
    tdAcoes.appendChild(bP);

    tb.appendChild(tr);
  });
  $('#hist-count').textContent = HIST.length ? `• ${HIST.length} registro(s)` : '';
  $('#hist-select-all').checked = false;
}

async function carregarHistorico(){
  try{
    const res = await api('listarSolicitacoes',{});
    HIST = res.dados || [];
    renderHistorico();
    showToast('Histórico carregado.');
  }catch(e){}
}

function obterSelecionados(){
  const nums = [];
  $$('#tabela-hist tbody input.hist-select').forEach(chk=>{
    if(chk.checked) nums.push(chk.dataset.num);
  });
  return nums;
}

async function excluirSelecionados(){
  const nums = obterSelecionados();
  if(!nums.length){
    showToast('Selecione ao menos um registro.');
    return;
  }
  if(!confirm('Confirmar exclusão dos selecionados?')) return;
  try{
    await api('excluirSolicitacoes',{numeros:nums});
    await carregarHistorico();
    showToast('Excluídos com sucesso.');
  }catch(e){}
}

function preencherFormulario(p){
  $('#req-num').value = p.numero;
  $('#tecnico').value = p.tecnico || '';
  preencherEndereco(p.tecnico || '');
  $('#data').value = p.data || '';
  $('#envio').value = p.envio || 'Normal';
  $('#obs').value = p.obs || '';
  $('#desc-valor').value = p.desconto || 0;
  $('#frete').value = p.frete || 0;
  const tb = $('#tbl-itens tbody');
  tb.innerHTML = '';
  if(p.itens && p.itens.length){
    p.itens.forEach(it=>adicionarLinha({
      codigo: it.codigo,
      idMaquina: it.idMaquina,
      qtd: it.qtd,
      descricao: it.descricao,
      valor: it.valor
    }));
  }else{
    adicionarLinha();
  }
  calcularTotais();
}

async function abrirPedido(numero){
  const p = HIST.find(x=>x.numero===numero);
  if(!p){
    showToast('Registro não encontrado no histórico.');
    return;
  }
  preencherFormulario(p);
  showToast('Pedido carregado no formulário.');
}

async function duplicarPedido(numero){
  const p = HIST.find(x=>x.numero===numero);
  if(!p){
    showToast('Registro não encontrado.');
    return;
  }
  const novo = JSON.parse(JSON.stringify(p));
  try{
    const r = await api('proximoNumero',{});
    novo.numero = r.numero;
    preencherFormulario(novo);
    showToast('Pedido duplicado. Verifique dados e envie.');
  }catch(e){}
}

/* ======== FORM PRINCIPAL ======== */
async function gerarNumero(){
  try{
    const r = await api('proximoNumero',{});
    $('#req-num').value = r.numero;
    $('#data').value = new Date().toISOString().slice(0,10);
  }catch(e){}
}

async function salvarPedido(){
  const pedido = montarPedido();
  if(!pedido) return;
  try{
    await api('salvarSolicitacao',{
      numero: pedido.numero,
      tecnico: pedido.tecnico,
      endereco: pedido.endereco,
      cidadeUF: pedido.cidadeUF,
      cep: pedido.cep,
      data: pedido.data,
      envio: pedido.envio,
      obs: pedido.obs,
      subtotal: pedido.subtotal,
      desconto: pedido.desconto,
      frete: pedido.frete,
      total: pedido.total,
      fluxo: pedido.fluxo
    });
    await api('salvarItens',{numero:pedido.numero, itens:pedido.itens});
    showToast('Solicitação salva com sucesso.');
    await carregarHistorico();
    limparFormulario(true);
  }catch(e){}
}

function limparFormulario(manterNumero){
  $('#tecnico').value = '';
  $('#endereco').value = '';
  $('#cidadeuf').value = '';
  $('#cep').value = '';
  $('#envio').value = 'Normal';
  $('#obs').value = '';
  $('#desc-valor').value = 0;
  $('#frete').value = 0;
  $('#tbl-itens tbody').innerHTML = '';
  adicionarLinha();
  calcularTotais();
  if(!manterNumero){
    gerarNumero();
  }
}

/* ======== INIT ======== */
function bindEventos(){
  $('#btn-config-api').addEventListener('click',()=>{
    const u = prompt('Informe a URL do WebApp (termina com /exec)', API_URL || '');
    if(u){
      API_URL = u.trim();
      localStorage.setItem('webappUrl', API_URL);
      atualizarBadgeApi();
      gerarNumero();
      carregarHistorico();
    }
  });
  $('#btn-add').addEventListener('click',()=>adicionarLinha());
  $('#btn-add-blank').addEventListener('click',()=>adicionarLinha({}));
  $('#desc-valor').addEventListener('input',calcularTotais);
  $('#frete').addEventListener('input',calcularTotais);
  $('#tecnico').addEventListener('change',()=>preencherEndereco($('#tecnico').value));
  $('#btn-enviar').addEventListener('click',salvarPedido);
  $('#btn-limpar').addEventListener('click',()=>limparFormulario(false));
  $('#btn-excel').addEventListener('click',()=>{
    const p = montarPedido();
    if(p) exportarExcel(p);
  });
  $('#btn-pdf').addEventListener('click',()=>{
    const p = montarPedido();
    if(p) exportarPDF(p);
  });
  $('#btn-hist-atualizar').addEventListener('click',carregarHistorico);
  $('#btn-hist-excluir').addEventListener('click',excluirSelecionados);
  $('#hist-select-all').addEventListener('change',e=>{
    const checked = e.target.checked;
    $$('#tabela-hist tbody input.hist-select').forEach(chk=>chk.checked = checked);
  });
}

async function init(){
  carregarApiUrl();
  preencherTecnicos();
  preencherPecas();
  adicionarLinha();
  bindEventos();
  if(API_URL){
    await gerarNumero();
    await carregarHistorico();
  }
}

window.addEventListener('load', init);
</script>
</body>
</html>
