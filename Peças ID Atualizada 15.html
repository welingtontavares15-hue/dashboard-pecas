<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üß∞ Solicita√ß√£o de Pe√ßas ‚Äî Local/Global (Power Automate)</title>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#3b82f6;
  --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--border:#334155;--shadow:0 4px 20px rgba(0,0,0,.2);
  --info:#06b6d4; --step:#8b5cf6;
}
:root.light{
  --bg:#eef8f1; --card:#ffffff; --text:#111827; --muted:#475569; --accent:#2563eb;
  --ok:#16a34a; --warn:#d97706; --danger:#b91c1c; --border:#cbd5e1; --shadow:0 2px 10px rgba(0,0,0,.08);
  --info:#0891b2; --step:#7c3aed;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{
  background:var(--card);
  background-image:linear-gradient(135deg, rgba(34,197,94,0.15), rgba(59,130,246,0.08));
  border-bottom:1px solid var(--border);
  padding:12px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:10;box-shadow:var(--shadow)
}
:root:not(.light) header{ background-image:none; }
h1{font-size:18px;margin:0}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
.badge{border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.04)}
button{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer;transition:.2s}
button:hover{background:var(--accent);color:#fff}
.btn-ok{background:var(--ok);border:none;color:#fff}
.btn-danger{background:var(--danger);border:none;color:#fff}
main{max-width:1200px;margin:0 auto;padding:20px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
.grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
.grid>label{grid-column:span 3;align-self:end;color:var(--muted);font-size:13px}
.grid>input,.grid>textarea,.grid>select{grid-column:span 9}
@media (max-width:900px){.grid{grid-template-columns:1fr}.grid>label,.grid>*{grid-column:auto}}
input,select,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
input[readonly]{opacity:.9}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:middle}
th{position:sticky;top:60px;background:var(--card)}
tr:hover{background:rgba(255,255,255,.04)}
td input, td select{width:100%}
.total-box{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;font-weight:600}
.total-box input{width:140px;text-align:right}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:50}
.toast.show{display:block}
tr.row-error{outline:2px solid var(--danger); background:rgba(239,68,68,.08)}
.small-hint{color:var(--muted); font-size:12px; margin-top:6px}
kbd{background:#0003;border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-size:12px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);max-width:900px;width:96%;padding:16px}
.modal h3{margin:0 0 10px 0}
.modal .issues{max-height:50vh;overflow:auto;border:1px dashed var(--border);border-radius:10px;padding:10px;background:rgba(255,255,255,.02)}
.modal .issue{padding:6px 8px;border-bottom:1px solid var(--border);font-size:14px}
.modal .issue:last-child{border-bottom:none}
.modal .muted{color:var(--muted);font-size:12px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
/* === FLUXO (cores no SELECT) === */
select.status{width:auto;min-width:160px;border:none;color:#fff;font-weight:600;border-radius:8px;padding:6px 8px}
select.status.flow-sup{background:var(--warn)}
select.status.flow-forn{background:var(--info)}
select.status.flow-rota{background:var(--step)}
select.status.flow-ent{background:var(--ok)}
/* filtros do hist√≥rico */
.hist-filtros{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.hist-filtros input,.hist-filtros select{max-width:220px}
.hist-empty{color:var(--muted); padding:10px 0}
/* A√ß√µes do hist√≥rico √† direita */
#tabela-hist td:last-child{display:flex;gap:8px;justify-content:flex-end}
.btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--text)}
/* === AUTOCOMPLETE de Pe√ßas === */
.suggest-wrap{position:relative}
.suggest{
  position:absolute; z-index:20; left:0; right:0; top:calc(100% + 4px);
  background:var(--card); border:1px solid var(--border); border-radius:10px;
  box-shadow:var(--shadow); max-height:260px; overflow:auto; display:none;
}
.suggest.show{display:block}
.suggest-item{padding:8px 10px; cursor:pointer; display:flex; gap:8px; align-items:center;}
.suggest-item:hover, .suggest-item.active{background:rgba(255,255,255,.06)}
.suggest-code{font-weight:700; min-width:62px}
.suggest-price{margin-left:auto; color:var(--muted); font-size:12px}
</style>
</head>
<body>
<header>
  <div style="display:flex;gap:10px;align-items:center">
    <h1>üß∞ Solicita√ß√£o de Pe√ßas</h1>
    <span id="badge-modo" class="badge">Modo: LOCAL</span>
  </div>
  <div class="toolbar">
    <button id="btn-modo-local">üíæ Local</button>
    <button id="btn-modo-global">‚òÅÔ∏è Global</button>
    <button id="btn-theme">üåó Tema</button>
    <button id="btn-auditar">ü©∫ Checar Consist√™ncia</button>
    <button id="btn-xlsx">üìä Excel</button>
    <button id="btn-pdf">üìÑ PDF</button>
    <button id="btn-enviar" class="btn-ok">üöÄ Enviar (Flow)</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>üîß Dados da Solicita√ß√£o</h2>
    <div class="grid">
      <label for="req-num">N¬∫ Solicita√ß√£o</label>
      <input id="req-num" readonly>

      <label for="tecnico">T√©cnico</label>
      <input id="tecnico" list="tecnicos" placeholder="Selecione o t√©cnico">
      <datalist id="tecnicos"></datalist>

      <label>Endere√ßo</label>
      <input id="endereco" readonly>
      <label>Bairro</label>
      <input id="bairro" readonly>
      <label>Munic√≠pio</label>
      <input id="municipio" readonly>
      <label>UF</label>
      <input id="uf" readonly>
      <label>CEP</label>
      <input id="cep" readonly>

      <label for="envio">Tipo de Envio</label>
      <select id="envio">
        <option value="Normal">Normal</option>
        <option value="Sedex">Sedex</option>
      </select>

      <label>Observa√ß√µes</label>
      <textarea id="obs" rows="2"></textarea>
    </div>
    <div class="small-hint">Atalhos: <kbd>Ctrl</kbd> + <kbd>Enter</kbd> = adicionar item ‚Ä¢ <kbd>Ctrl</kbd> + <kbd>E</kbd> = enviar</div>
  </section>

  <section class="card">
    <h2>üì¶ Itens da Solicita√ß√£o</h2>
    <datalist id="pecas"></datalist>
    <table id="tabela-itens">
      <thead>
        <tr>
          <th style="width:120px">C√≥digo</th>
          <th>Descri√ß√£o</th>
          <th style="width:200px">ID M√°quina</th>
          <th style="width:90px">Qtd</th>
          <th style="width:150px">Valor Unit√°rio</th>
          <th style="width:150px">Subtotal</th>
          <th style="width:110px">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button id="add-item" type="button" class="btn-ok">‚ûï Adicionar Item</button>
      <div class="total-box">
        Subtotal: <span id="subtotal">R$ 0,00</span>
        ¬∑ Desconto (R$): <input id="desc-valor" type="number" step="0.01" min="0" value="0">
        ¬∑ Frete (R$): <input id="frete" type="number" step="0.01" value="0">
        ¬∑ <strong>Total:</strong> <span id="total-geral">R$ 0,00</span>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="toolbar">
      <button id="btn-hist" type="button">üìö Mostrar Hist√≥rico</button>
      <button id="btn-ocultar-hist" type="button">üôà Ocultar Hist√≥rico</button>
      <button id="btn-nova" type="button">üÜï Nova Solicita√ß√£o</button>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section class="card" id="hist" style="display:none">
    <h2>üìö Mostrar Hist√≥rico</h2>

    <div class="hist-filtros" style="align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="f-num" placeholder="Filtrar por N¬∫">
        <input id="f-data" type="date" placeholder="Data">
        <input id="f-tec" placeholder="T√©cnico">
        <select id="f-status">
          <option value="">Fluxo (todos)</option>
          <option>Supervisor Diversey</option>
          <option>Fornecedor</option>
          <option>Rota de Entrega</option>
          <option>Entregue</option>
        </select>
        <button id="f-limpar">Limpar</button>
      </div>

      <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="hist-del" class="btn-danger" title="Excluir pedidos selecionados">üóëÔ∏è Excluir selecionados</button>
      </div>
    </div>

    <div class="hist-empty" id="hist-empty" style="display:none">Sem registros para os filtros atuais.</div>

    <table id="tabela-hist">
      <thead>
        <tr>
          <th style="width:36px; text-align:center">
            <input id="hist-select-all" type="checkbox" title="Selecionar todos">
          </th>
          <th>N¬∫</th>
          <th>Data</th>
          <th>T√©cnico</th>
          <th>Itens</th>
          <th>Total</th>
          <th>Fluxo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Modal Relat√≥rio -->
<div id="modal-audit" class="modal-backdrop">
  <div class="modal">
    <h3>Relat√≥rio de Consist√™ncia</h3>
    <div id="audit-summary" class="muted"></div>
    <div id="audit-issues" class="issues" style="margin-top:8px"></div>
    <div class="actions" id="audit-actions">
      <button id="audit-close">Fechar</button>
      <button id="audit-fix">Corrigir e Fechar</button>
      <button id="audit-ignore" class="btn-ok">Ignorar e Enviar</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
'use strict';
/* ========= Helpers ========= */
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const BRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const toast = (m,ms=2200)=>{const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);};
const clamp = (v,min,max)=>Math.min(max,Math.max(min,v||0));
const collator = new Intl.Collator('pt-BR',{sensitivity:'base'});
function fmtDataSolic(data){
  if(!data) return new Date().toLocaleDateString('pt-BR');
  if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(data)){
    const [y,m,d]=data.split('-'); return `${d}/${m}/${y}`;
  }
  return data;
}

/* ========= Config ========= */
const LS = { PARTS:'sp_parts_v3', TECHS:'sp_techs_v3', ORD:'sp_orders_v3', CUR:'sp_current_v3', SEQ:'sp_seq_v1', THEME:'sp_theme', MODO:'sp_modo_integracao' };
const API_SAVE = 'COLE_AQUI_URL_DO_FLOW_SALVAR';
const API_LIST = 'COLE_AQUI_URL_DO_FLOW_LISTAR';
const API_UPDATE_STATUS = 'COLE_AQUI_URL_DO_FLOW_STATUS';
const getModo = () => localStorage.getItem(LS.MODO) || 'local';
const setModo = m => { localStorage.setItem(LS.MODO,m); $('#badge-modo').textContent='Modo: '+m.toUpperCase(); toast(m==='global'?'Modo GLOBAL (Excel) ativo':'Modo LOCAL ativo'); };

/* ========= Pe√ßas (base) ‚Äî 120 itens ========= */
const itensBase = [
  {"codigo":"CS001","descricao":"Adaptador Bra√ßo Lavagem HD-80","valor":225.00},
  {"codigo":"CS002","descricao":"Adaptador Do Bra√ßo De Lavagem (Tarugo) HD-50","valor":175.70},
  {"codigo":"CS003","descricao":"Adaptador Do Bra√ßo De Lavagem (Tarugo) HD-80","valor":205.00},
  {"codigo":"CS004","descricao":"Adaptador Interno HD-80","valor":350.00},
  {"codigo":"CS005","descricao":"Arruela De Rota√ß√£o HD-80","valor":40.00},
  {"codigo":"CS006","descricao":"Assento Do Bra√ßo De Lavagem (Bucha) HD-50","valor":101.00},
  {"codigo":"CS007","descricao":"Batente Lateral HD-80","valor":105.00},
  {"codigo":"CS008","descricao":"Bicos Injetores Do Bra√ßo HD-50/HD-80","valor":114.48},
  {"codigo":"CS009","descricao":"Boiler HD-50","valor":2033.00},
  {"codigo":"CS010","descricao":"Boiler HD-80","valor":2355.00},
  {"codigo":"CS011","descricao":"Boma De Enxague (Importada) HD-50","valor":2007.79},
  {"codigo":"CS012","descricao":"Boma De Enxague (Nacional) HD-80","valor":1550.00},
  {"codigo":"CS013","descricao":"Bomba De Lavagem HD-50","valor":7529.22},
  {"codigo":"CS014","descricao":"Bomba De Lavagem HD-80","valor":11293.85},
  {"codigo":"CS015","descricao":"Bra√ßo Capo HD-80","valor":1255.00},
  {"codigo":"CS016","descricao":"Bra√ßo De Lavagem HD-50","valor":1205.00},
  {"codigo":"CS017","descricao":"Bra√ßo De Lavagem Superior Completo HD-80","valor":1715.00},
  {"codigo":"CS018","descricao":"Caixa De Montagem El√©trica HD-80","valor":680.00},
  {"codigo":"CS019","descricao":"Caixa De Montagem HD-50","valor":225.88},
  {"codigo":"CS020","descricao":"Capa Do Filtro De Residuo HD-50","valor":150.60},
  {"codigo":"CS021","descricao":"Capo HD-80","valor":5020.00},
  {"codigo":"CS022","descricao":"Cesto De Res√≠duo HD-80","valor":150.60},
  {"codigo":"CS023","descricao":"Chicote NR12","valor":3210.00},
  {"codigo":"CS024","descricao":"Conex√£o Bra√ßo HD-80","valor":1507.00},
  {"codigo":"CS025","descricao":"Conj Termostato","valor":886.72},
  {"codigo":"CS026","descricao":"Conjunto de cesto de residuo NT-300","valor":1123.05},
  {"codigo":"CS027","descricao":"Contactora De Comando HD-80","valor":328.00},
  {"codigo":"CS028","descricao":"Contatora HD-50","valor":328.00},
  {"codigo":"CS029","descricao":"Curva Bra√ßo Superior HD-50","valor":115.00},
  {"codigo":"CS030","descricao":"Disjuntor 10A HD-80","valor":375.00},
  {"codigo":"CS031","descricao":"Disjuntor 125A","valor":1776.85},
  {"codigo":"CS032","descricao":"Disjuntor 80A","valor":313.20},
  {"codigo":"CS033","descricao":"Eixo De Suporte Do Bra√ßo  HD-50","valor":301.50},
  {"codigo":"CS034","descricao":"Etiqueta Painel NT","valor":545.90},
  {"codigo":"CS035","descricao":"Filtro De Residuo HD-50","valor":742.00},
  {"codigo":"CS036","descricao":"Filtro De Residuo Hdw-80 HD-80","valor":401.56},
  {"codigo":"CS037","descricao":"Fim de curso HDW-200","valor":789.21},
  {"codigo":"CS038","descricao":"Fim de curso HDW-200 (Completo)","valor":2175.50},
  {"codigo":"CS039","descricao":"Flange Bra√ßo Inferior HD-50","valor":742.00},
  {"codigo":"CS040","descricao":"Flange Bra√ßo Superior HD-50","valor":742.00},
  {"codigo":"CS041","descricao":"Flauta De Enxague (S/ Bicos) HD-80","valor":125.50},
  {"codigo":"CS042","descricao":"Flauta Do Bra√ßo HD-50","valor":125.50},
  {"codigo":"CS043","descricao":"Flauta HD-80","valor":1204.75},
  {"codigo":"CS044","descricao":"Fonte 24V 10A HD-50/HD-80","valor":155.00},
  {"codigo":"CS045","descricao":"Kit Mangueiras (Agua + Dreno) HD-50/HD-80","valor":240.00},
  {"codigo":"CS046","descricao":"Luva Bra√ßo Superior HD-50","valor":90.00},
  {"codigo":"CS047","descricao":"Mangueira De Borracha HD-80","valor":95.00},
  {"codigo":"CS048","descricao":"Mola Da Porta HD-50","valor":75.00},
  {"codigo":"CS049","descricao":"Mola Do Capo HD-80","valor":830.00},
  {"codigo":"CS050","descricao":"Painel El√©trico Completo HD-50","valor":9550.00},
  {"codigo":"CS051","descricao":"Painel Ihm HD-50/HD-80","valor":1588.00},
  {"codigo":"CS052","descricao":"Parafuso Da Rondana HD-50","valor":75.29},
  {"codigo":"CS053","descricao":"Parafuso De Fixa√ß√£o Bra√ßo De Lavagem HD-80","valor":105.00},
  {"codigo":"CS054","descricao":"Parafuso De Fixa√ß√£o Da Polia HD-80","valor":145.00},
  {"codigo":"CS055","descricao":"Pino Batente Lateral Capo HD-80","valor":130.00},
  {"codigo":"CS056","descricao":"Placa Controladora HD-50/HD-80","valor":6307.00},
  {"codigo":"CS057","descricao":"Placa De Montagem HD-50","valor":280.00},
  {"codigo":"CS058","descricao":"Polia De Movimenta√ß√£o Do Capo HD-80","valor":135.00},
  {"codigo":"CS059","descricao":"Polia Inferior Do Capo HD-80","valor":150.00},
  {"codigo":"CS060","descricao":"Porta HD-50","valor":1760.00},
  {"codigo":"CS061","descricao":"Pressostato De N√≠vel HD-50","valor":610.00},
  {"codigo":"CS062","descricao":"Pressostato HDW-200","valor":453.68},
  {"codigo":"CS063","descricao":"Pressotato De N√≠vel HD-80","valor":572.40},
  {"codigo":"CS064","descricao":"Pulm√£o HD-80","valor":500.00},
  {"codigo":"CS065","descricao":"Rel√© De Prote√ß√£o HD-50/HD-80","valor":414.11},
  {"codigo":"CS067","descricao":"Resistencia do booster HDW-200","valor":1696.00},
  {"codigo":"CS068","descricao":"Resistencia Do Tanque Com  Flange Hd50","valor":1017.60},
  {"codigo":"CS069","descricao":"Resistencia Do Tanque Com  Flange Hd80","valor":1023.00},
  {"codigo":"CS070","descricao":"Resistencia do TQ HDW-200","valor":1346.73},
  {"codigo":"CS071","descricao":"Resistencia NT-300","valor":1696.00},
  {"codigo":"CS072","descricao":"Resist√™ncias Boiler Com  Flange  Hd50","valor":1272.00},
  {"codigo":"CS073","descricao":"Resist√™ncias Boiler Com  Flange  Hd80","valor":1484.00},
  {"codigo":"CS074","descricao":"Roldana HD-80","valor":163.50},
  {"codigo":"CS075","descricao":"Rondana Da Porta HD-50","valor":75.00},
  {"codigo":"CS076","descricao":"Saida Do Dreno HD-50","valor":476.85},
  {"codigo":"CS077","descricao":"Sensor Capo HD-80","valor":108.45},
  {"codigo":"CS078","descricao":"Sensor De Nivel HD-50","valor":606.74},
  {"codigo":"CS079","descricao":"Sensor De N√≠vel HD-80","valor":606.74},
  {"codigo":"CS080","descricao":"Sensor De Temperatura HD-50","valor":255.00},
  {"codigo":"CS081","descricao":"Solenoide De Agua HD-50","valor":175.00},
  {"codigo":"CS082","descricao":"Sonda Temperatura","valor":320.51},
  {"codigo":"CS083","descricao":"Suporte Bomba De Lavagem HD-80","valor":75.00},
  {"codigo":"CS084","descricao":"Suporte Bra√ßo Capo HD-80","valor":40.00},
  {"codigo":"CS085","descricao":"Suporte Capo HD-80","valor":150.00},
  {"codigo":"CS086","descricao":"Suporte Do Boiler HD-80","valor":225.00},
  {"codigo":"CS087","descricao":"Suporte Do Rack HD-80","valor":1255.00},
  {"codigo":"CS088","descricao":"Suporte Fixa√ß√£o HD-80","valor":155.00},
  {"codigo":"CS089","descricao":"Suporte Gancho Bomba De Lavagem HD-80","valor":350.00},
  {"codigo":"CS090","descricao":"Suporte Luva Para Mangeira Do Dreno HD-80","valor":276.00},
  {"codigo":"CS091","descricao":"Suporte Painel HD-80","valor":405.00},
  {"codigo":"CS092","descricao":"Suporte Regul√°vel De Altura(P√©) HD-80","valor":335.00},
  {"codigo":"CS093","descricao":"Suporte Termostato Do Boiler HD-80","valor":51.00},
  {"codigo":"CS094","descricao":"Tampa Frontal HD-50","valor":602.34},
  {"codigo":"CS095","descricao":"Tampa Frontal HD-80","valor":230.00},
  {"codigo":"CS096","descricao":"Tampa Inferior HD-50","valor":502.00},
  {"codigo":"CS097","descricao":"Tampa Inferior Traseira HD-50","valor":955.00},
  {"codigo":"CS098","descricao":"Tampa Lateral Direita HD-50","valor":905.00},
  {"codigo":"CS099","descricao":"Tampa Lateral HD-80","valor":705.00},
  {"codigo":"CS100","descricao":"Tampa Superior HD-50","valor":1130.00},
  {"codigo":"CS101","descricao":"Tampa Superior HD-80","valor":205.00},
  {"codigo":"CS102","descricao":"Tampa Traseira HD-50","valor":1005.00},
  {"codigo":"CS103","descricao":"Tampa Traseira HD-80","valor":715.00},
  {"codigo":"CS104","descricao":"Tampao Do Dreno HD-50","valor":119.06},
  {"codigo":"CS105","descricao":"Tamp√£o Do Dreno HD-80","valor":183.60},
  {"codigo":"CS106","descricao":"Tela De Filtro De Res√≠duo Direito HD-80","valor":337.61},
  {"codigo":"CS107","descricao":"Tela De Filtro De Res√≠duo Esquerdo HD-80","valor":337.61},
  {"codigo":"CS108","descricao":"Terminal De Aterramento HD-50","valor":55.50},
  {"codigo":"CS109","descricao":"Termostato Do Boiler HD-50/H80","valor":901.00},
  {"codigo":"CS110","descricao":"Termostato Do Tanque HD/HD-80","valor":254.40},
  {"codigo":"CS111","descricao":"Trilho Dim HD-50/HD-80","valor":40.00},
  {"codigo":"CS112","descricao":"Tubo Bra√ßo Lavagem Superior HD-80","valor":1635.00},
  {"codigo":"CS113","descricao":"Tubo Da Bomba De Lavagem (Mangote Curvo) HD-80","valor":350.00},
  {"codigo":"CS114","descricao":"Tubo De Drenagem Hdw-80 HD-80","valor":355.00},
  {"codigo":"CS115","descricao":"Tubo De Saida Da Bomba De Lavagem HD-50","valor":225.88},
  {"codigo":"CS116","descricao":"Tubo Saida Bomba De Lavagem HD-80","valor":263.55},
  {"codigo":"CS117","descricao":"Tupo Bra√ßo Superior HD-50","valor":52.00},
  {"codigo":"CS118","descricao":"Valvula De Agua HD-80","valor":159.00},
  {"codigo":"CS119","descricao":"Valvula Solenoide HDW-200 NT","valor":172.50},
  {"codigo":"CS120","descricao":"Etiqueta Painel","valor":69.00}
];


/* ========= T√©cnicos (ordenados alfabeticamente) ========= */
const tecnicosBase={
  "Antonio Ferreira De Santana Filho":{"endereco":"Av Curi√≥ - Campan√°rio, Ap 510 Bloco B","bairro":"","cep":"09.925-000","municipio":"Diadema","uf":"SP"},
  "Antonio Rocker":{"endereco":"Rua Estoril 131","bairro":"Veleiros","cep":"47.730-900","municipio":"S√£o Paulo","uf":"SP"},
  "Brunno Diniz Mendes":{"endereco":"Rua Nova 1 N 22B","bairro":"Tijup√° Queimado","cep":"65.110-000","municipio":"S√£o Jos√© de Ribamar","uf":"MA"},
  "Carlos Alberto De Vasconcelos Junior":{"endereco":"Deputado Jo√£o Ursulo Ribeiro Filho A 149","bairro":"Mangabeira I","cep":"58.055-360","municipio":"Jo√£o Pessoa","uf":"PB"},
  "Dalvino Carlos Santos Junior":{"endereco":"Rua vivaldo sales 158, apartamento 41","bairro":"jardim s√£o jos√©","cep":"11-430 140","municipio":"guaruj√° s√£o paulo","uf":"SP"},
  "Davidson Alves Vitorino":{"endereco":"Jacarand√° N¬∞ 157","bairro":"Sapucaias 3","cep":"32.071-236","municipio":"Contagem","uf":"MG"},
  "Diego Abner de Oliveira":{"endereco":"Rua M√°rio Campos 71 AP 401 Bloco 08","bairro":"","cep":"12.221-750","municipio":"S√£o Jose do Campos","uf":"SP"},
  "Ednaldo Silva Costa":{"endereco":"Rua Olimp√≠o Cassimiro Mendon√ßa, 542","bairro":"Parque das Am√©ricas","cep":"38.045-360","municipio":"Uberaba","uf":"MG"},
  "Ediveton Pedro Da Silva":{"endereco":"Rua M√°rio Prieto 500","bairro":"Jardim Paulista","cep":"13.310-000","municipio":"Itu","uf":"SP"},
  "Eduardo Martins":{"endereco":"Rua Rafael da Silva e Souza N¬∞510","bairro":"Cidade L√≠der","cep":"08280-090","municipio":"S√£o Paulo","uf":"SP"},
  "Emerson Ribeiro":{"endereco":"Rua S√£o Crist√≥v√£o, 471 Casa 03","bairro":"","cep":"88.080-320","municipio":"Florian√≥polis","uf":"SC"},
  "Fernando Silva":{"endereco":"Hermelindo Lazarini, 69","bairro":"Jardim das Na√ß√µes","cep":"79.081-714","municipio":"Campo Grande","uf":"MS"},
  "Getulio Santos De Almeida":{"endereco":"Rua Nara Le√£o, N¬∞ 125. Apto Jarmim 1103","bairro":"Jardim Limoeiro","cep":"29.164-125","municipio":"Serra","uf":"ES"},
  "Humberto Elias Dos Santos Da Silva":{"endereco":"Av Jose Aloisio Filho N¬∞ 411 Apto 368 Bloco Q","bairro":"Humaita","cep":"90.250-180","municipio":"Porto Alegre","uf":"RS"},
  "Joao Celso Silva De Souza":{"endereco":"Leonardo da Vinci 96 Bloco C Ap 306","bairro":"Curado II","cep":"54.220-000","municipio":"Jaboat√£o dos Guararapes","uf":"PE"},
  "Leandro Rocha Cruz":{"endereco":"R. Dom Pedro II 537A Fundos","bairro":"Centro","cep":"14.820-290","municipio":"Cidade Am√©rico Brasiliense - SP","uf":"SP"},
  "Maicon Cordeiro Chaves":{"endereco":"Rua Saxonia N¬∞ 2013","bairro":"Vila Itoupava","cep":"89.075-255","municipio":"Blumenau","uf":"SC"},
  "Marcio Andrade Dos Santos":{"endereco":"1¬∞ Travessa Renato Lima de Carvalho N¬∞ 33","bairro":"Jardim Alvorada","cep":"42.850-000","municipio":"Dias davila","uf":"BA"},
  "Marlon de Queiroz":{"endereco":"AV. Juscelino Kubitschek, 3700 Bloco-E, Apto -301","bairro":"Passare","cep":"60.861.634","municipio":"Fortaleza","uf":"CE"},
  "Ney Goncalves Cardoso":{"endereco":"Rua Juqueri,266","bairro":"Iraj√°","cep":"21.371-370","municipio":"Rio de Janeiro","uf":"RJ"},
  "Pedro Gabriel Reis Nunes":{"endereco":"Rua Cristo Rei, 230, casa 101.","bairro":"S√£o Jos√©","cep":"97095-680","municipio":"Santa Maria","uf":"RS"},
  "Rodrigo Lazari De Carvalho":{"endereco":"Rua alonso Vasconcelos pacheco 1327","bairro":"","cep":"09310-695","municipio":"Maua","uf":"SP"},
  "Sebasti√£o Gomes Ribeiro":{"endereco":"RUA THOME DE SOUZA, 335","bairro":"LAGOA GRANDE ‚Äì SEDE","cep":"45.810-000","municipio":"PORTO SEGURO","uf":"BA"},
  "Welington Bastos Tavares":{"endereco":"AV Morumbi Qd 34 Lt 11","bairro":"Vila Mariana","cep":"75.134-550","municipio":"An√°polis","uf":"GO"}
};

/* ========= Datalists ========= */
function preencherListas(){
  const dlT=$('#tecnicos'); dlT.innerHTML='';
  Object.keys(tecnicosBase).sort(collator.compare).forEach(n=>{
    const o=document.createElement('option'); o.value=n; dlT.appendChild(o);
  });
  const dlP=$('#pecas'); dlP.innerHTML='';
  itensBase.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.codigo;
    o.label=`${p.codigo} ‚Äî ${p.descricao} ‚Äî ${BRL(p.valor)}`;
    dlP.appendChild(o);
  });
}

/* ========= Endere√ßo do t√©cnico ========= */
function preencherEndereco(nome){
  const d=tecnicosBase[nome]; if(!d) return;
  $('#endereco').value=d.endereco||''; $('#bairro').value=d.bairro||'';
  $('#municipio').value=d.municipio||''; $('#uf').value=d.uf||''; $('#cep').value=d.cep||'';
}

/* ========= Busca item ========= */
function normalizeCode(v){
  if(!v) return null;
  const raw=String(v).toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(/^CS\d{1,3}$/.test(raw)) return 'CS'+raw.slice(2).padStart(3,'0');
  const m=String(v).match(/cs\s*-?\s*(\d{1,3})/i); if(m) return 'CS'+m[1].padStart(3,'0');
  if(/^\d{1,3}$/.test(raw)) return 'CS'+raw.padStart(3,'0');
  return null;
}
function findItem(input){
  const norm=normalizeCode(input);
  if(norm){ return itensBase.find(x=>x.codigo===norm)||null; }
  const s=(input||'').toString().trim().toLowerCase();
  return itensBase.find(x=>x.descricao.toLowerCase()===s) ||
         itensBase.find(x=>x.descricao.toLowerCase().startsWith(s)) || null;
}
function fillRowFromItem(tr,item){
  tr.querySelector('.codigo').value=item.codigo;
  tr.querySelector('.desc').value=item.descricao;
  tr.querySelector('.valor').value=Number(item.valor||0);
  calcTotal();
}

/* ========= ID M√°quina ========= */
function normalizeId(value){ return String(value ?? '').trim(); }
function wireIdValidation(input){
  const run = ()=>{ input.value = normalizeId(input.value); };
  input.addEventListener('change',run);
  input.addEventListener('blur',run);
  input.title = 'ID da M√°quina ‚Äî qualquer formato √© aceito.';
}

/* ========= AUTOCOMPLETE de pe√ßas ========= */
function makeSuggestUI(input, rowRef){
  const wrap=document.createElement('div');
  wrap.className='suggest-wrap';
  input.parentElement.insertBefore(wrap, input);
  wrap.appendChild(input);
  const list=document.createElement('div'); list.className='suggest'; wrap.appendChild(list);
  let results=[], active=-1, lastQuery='';
  const render=(items)=>{
    list.innerHTML='';
    if(!items.length){ list.classList.remove('show'); return; }
    items.slice(0,100).forEach((p,idx)=>{
      const div=document.createElement('div'); div.className='suggest-item'; div.dataset.idx=idx;
      const c=document.createElement('span'); c.className='suggest-code'; c.textContent=p.codigo;
      const d=document.createElement('span'); d.textContent=p.descricao;
      const pr=document.createElement('span'); pr.className='suggest-price'; pr.textContent=BRL(p.valor);
      div.appendChild(c); div.appendChild(d); div.appendChild(pr);
      div.addEventListener('mousedown',(ev)=>{ ev.preventDefault(); choose(idx); });
      list.appendChild(div);
    });
    list.classList.add('show'); active=-1;
  };
  const choose=(idx)=>{
    const p=results[idx]; if(!p) return;
    const tr=rowRef.closest('tr');
    tr.querySelector('.codigo').value=p.codigo;
    tr.querySelector('.desc').value=p.descricao;
    tr.querySelector('.valor').value=p.valor;
    list.classList.remove('show');
    calcTotal();
  };
  const keyNav=(ev)=>{
    if(!list.classList.contains('show')) return;
    const max=results.length-1;
    const items=[...list.querySelectorAll('.suggest-item')];
    if(ev.key==='ArrowDown'){ ev.preventDefault(); active=Math.min(max,active+1); }
    else if(ev.key==='ArrowUp'){ ev.preventDefault(); active=Math.max(0,active-1); }
    else if(ev.key==='Enter'){ ev.preventDefault(); if(active>=0) choose(active); return; }
    else if(ev.key==='Escape'){ list.classList.remove('show'); return; }
    items.forEach((el,i)=>el.classList.toggle('active',i===active));
    if(active>=0){ items[active].scrollIntoView({block:'nearest'}); }
  };
  const doFilter=()=>{
    const q=input.value.trim().toLowerCase();
    if(q===lastQuery) return; lastQuery=q;
    if(!q){ list.classList.remove('show'); return; }
    results = itensBase.filter(p=> p.codigo.toLowerCase().includes(q) || p.descricao.toLowerCase().includes(q) );
    render(results);
  };
  input.addEventListener('input',doFilter);
  input.addEventListener('keydown',keyNav);
  input.addEventListener('blur',()=>setTimeout(()=>list.classList.remove('show'),150));
}

/* ========= Tabela ========= */
function addRow(pref={}){
  const tb=$('#tabela-itens tbody');
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input list="pecas" class="codigo" placeholder="CS001" value="${pref.codigo||''}"></td>
    <td><input class="desc" placeholder="Digite nome/c√≥digo da pe√ßa" value="${pref.descricao||''}"></td>
    <td><input class="idmaq" placeholder="Ex.: 38925 ou HLHDW8017HL2091-027" value="${normalizeId(pref.idMaquina||pref.idmaq||'')}"></td>
    <td><input type="number" class="qtd" min="1" value="${clamp(pref.qtd,1,9999)||1}"></td>
    <td><input type="number" class="valor" step="0.01" min="0" value="${Math.max(0,Number(pref.valor||0))||''}"></td>
    <td class="sub">R$ 0,00</td>
    <td><button class="btn-danger del" type="button">Excluir</button></td>`;
  tb.appendChild(tr);

  const iCod=tr.querySelector('.codigo');
  const iDesc=tr.querySelector('.desc');
  const iQtd=tr.querySelector('.qtd');
  const iVal=tr.querySelector('.valor');
  const iId =tr.querySelector('.idmaq');

  iCod.addEventListener('input',()=>{ const it=findItem(iCod.value); if(it) fillRowFromItem(tr,it); });
  iCod.addEventListener('change',()=>{ const it=findItem(iCod.value); if(it) fillRowFromItem(tr,it); });
  iDesc.addEventListener('change',()=>{ const it=findItem(iDesc.value); if(it) fillRowFromItem(tr,it); });

  makeSuggestUI(iDesc, iDesc);

  iQtd.addEventListener('input',()=>{ iQtd.value = clamp(iQtd.value,1,9999); calcTotal(); });
  iVal.addEventListener('input',()=>{ iVal.value = Math.max(0,Number(iVal.value||0)); calcTotal(); });
  tr.querySelector('.del').addEventListener('click',(e)=>{ e.preventDefault(); tr.remove(); calcTotal(); });

  wireIdValidation(iId);

  if(pref.codigo){ const it=findItem(pref.codigo); if(it) fillRowFromItem(tr,it); }
  calcTotal();
}
function collectItems(){
  const itens=[];
  $$('#tabela-itens tbody tr').forEach(tr=>{
    const codigo=tr.querySelector('.codigo').value.trim().toUpperCase();
    const descricao=tr.querySelector('.desc').value.trim();
    const idMaquina=normalizeId((tr.querySelector('.idmaq').value||''));
    const qtd=clamp(parseFloat(tr.querySelector('.qtd').value),1,9999);
    const valor=Math.max(0, parseFloat(tr.querySelector('.valor').value)||0);
    if(descricao && qtd>0){ itens.push({codigo,descricao,idMaquina,qtd,valor,subtotal:qtd*valor}); }
  });
  return itens;
}

/* ========= Totais (Desconto em R$ aplicado no total) ========= */
function calcTotal(){
  let subtotal=0;
  $$('#tabela-itens tbody tr').forEach(tr=>{
    const q=clamp(parseFloat(tr.querySelector('.qtd').value),1,9999);
    const v=Math.max(0, parseFloat(tr.querySelector('.valor').value)||0);
    const s=q*v; subtotal+=s;
    tr.querySelector('.sub').textContent=BRL(s);
  });
  const descValor = Math.max(0, parseFloat($('#desc-valor').value)||0);
  const frete     = Math.max(0, parseFloat($('#frete').value)||0);
  const total     = Math.max(0, subtotal - descValor + frete);
  $('#desc-valor').value = descValor;
  $('#frete').value = frete;
  $('#subtotal').textContent=BRL(subtotal);
  $('#total-geral').textContent=BRL(total);
  return {subtotal,total,descValor,frete};
}

/* ========= Fluxo ========= */
const FLUXO = ['Supervisor Diversey','Fornecedor','Rota de Entrega','Entregue'];
function applyFlowStyle(selectEl, value){
  selectEl.classList.remove('flow-sup','flow-forn','flow-rota','flow-ent');
  if(value==='Supervisor Diversey') selectEl.classList.add('flow-sup');
  else if(value==='Fornecedor')     selectEl.classList.add('flow-forn');
  else if(value==='Rota de Entrega')selectEl.classList.add('flow-rota');
  else if(value==='Entregue')       selectEl.classList.add('flow-ent');
  else selectEl.classList.add('flow-sup');
}
function makeFlowSelect(value, disabled=false){
  const sel=document.createElement('select');
  sel.className='status';
  sel.disabled = disabled;
  FLUXO.forEach(st=>{
    const opt=document.createElement('option');
    opt.value=st; opt.textContent=st;
    if(st===value) opt.selected=true;
    sel.appendChild(opt);
  });
  applyFlowStyle(sel, value||'Supervisor Diversey');
  sel.addEventListener('change',()=>applyFlowStyle(sel, sel.value));
  return sel;
}

/* ========= Sequ√™ncia ========= */
function gerarNumero(){
  const d=new Date();
  const key = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  let seq=JSON.parse(localStorage.getItem(LS.SEQ)||'{}');
  if(seq.date!==key){ seq={date:key,counter:1}; }
  const numero=`REQ-${key}-${String(seq.counter).padStart(4,'0')}`;
  $('#req-num').value=numero;
  seq.counter++; localStorage.setItem(LS.SEQ, JSON.stringify(seq));
}

/* ========= Sele√ß√£o & Exclus√£o (Hist√≥rico) ========= */
function getHistoricoSelecionados(){
  return [...document.querySelectorAll('#tabela-hist tbody input.hist-select:checked')]
    .map(chk => chk.value).filter(Boolean);
}
function excluirSelecionadosLocal(){
  const numeros = getHistoricoSelecionados();
  if(!numeros.length){ toast('Nenhum pedido selecionado'); return; }
  const ok = confirm(`Excluir ${numeros.length} pedido(s) do hist√≥rico LOCAL? Esta a√ß√£o n√£o pode ser desfeita.`);
  if(!ok) return;
  let lista = JSON.parse(localStorage.getItem(LS.ORD) || '[]');
  const antes = lista.length;
  lista = lista.filter(o => !numeros.includes(o.numero));
  localStorage.setItem(LS.ORD, JSON.stringify(lista));
  const cur = JSON.parse(localStorage.getItem(LS.CUR) || 'null');
  if(cur && numeros.includes(cur.numero)){ localStorage.removeItem(LS.CUR); }
  toast(`Removido(s): ${antes - lista.length}`);
  montarHistoricoLocal();
}
function bindSelectAll(){
  const master = document.getElementById('hist-select-all');
  if(!master) return;
  master.addEventListener('change', ()=>{
    document.querySelectorAll('#tabela-hist tbody input.hist-select')
      .forEach(chk => { chk.checked = master.checked; });
  });
}

/* ========= Filtros ========= */
function aplicaFiltrosLinhas(rows){
  const fnum  = ($('#f-num').value||'').trim().toLowerCase();
  const fdata = ($('#f-data').value||'').trim();
  const ftec  = ($('#f-tec').value||'').trim().toLowerCase();
  const fstat = ($('#f-status').value||'').trim();

  rows.forEach(tr=>{
    const numEl = tr.querySelector('.td-num');
    const datEl = tr.querySelector('.td-data');
    const tecEl = tr.querySelector('.td-tec');
    const sel   = tr.querySelector('select.status');

    const num = (numEl?.textContent||'').toLowerCase();
    const dat = (datEl?.textContent||'').trim();
    const tec = (tecEl?.textContent||'').toLowerCase();
    const st  = sel ? sel.value : '';

    const ok =
      (!fnum  || num.includes(fnum)) &&
      (!fdata || dat===fdata) &&
      (!ftec  || tec.includes(ftec)) &&
      (!fstat || st===fstat);

    tr.style.display = ok ? '' : 'none';
  });

  const anyVisible = [...rows].some(tr=>tr.style.display!=='none');
  $('#hist-empty').style.display = anyVisible ? 'none' : 'block';
}
function bindFiltros(){
  ['#f-num','#f-data','#f-tec','#f-status'].forEach(id=>{
    $(id).addEventListener('input',()=>aplicaFiltrosLinhas($$('#tabela-hist tbody tr')));
    $(id).addEventListener('change',()=>aplicaFiltrosLinhas($$('#tabela-hist tbody tr')));
  });
  $('#f-limpar').addEventListener('click',()=>{
    $('#f-num').value=''; $('#f-data').value=''; $('#f-tec').value=''; $('#f-status').value='';
    aplicaFiltrosLinhas($$('#tabela-hist tbody tr'));
  });
}

/* ========= Exports ========= */
function orderToAOA(o){
  const dataSolic = fmtDataSolic(o.data);
  const head=[
    'N¬∫ Solicita√ß√£o','Data da Solicita√ß√£o','T√©cnico',
    'C√≥digo','ID M√°quina','Qtd','Descri√ß√£o','Valor Unit√°rio','Subtotal'
  ];
  const rows=(o.itens||[]).map(it=>[
    o.numero || '', dataSolic, o.tecnico || '-',
    it.codigo||'', (it.idMaquina||''), it.qtd, it.descricao,
    Number(it.valor||0), Number(it.qtd*it.valor||0)
  ]);
  return [head,...rows];
}
function exportXLSXFrom(o){
  const wb=XLSX.utils.book_new();
  const ws1=XLSX.utils.aoa_to_sheet(orderToAOA(o));
  ws1['!cols']=[{wch:22},{wch:18},{wch:30},{wch:10},{wch:28},{wch:6},{wch:46},{wch:14},{wch:14}];
  XLSX.utils.book_append_sheet(wb,ws1,'Itens');

  // Resumo com Tipo de Envio e Desconto R$
  const ws2=XLSX.utils.aoa_to_sheet([
    ['N√∫mero',o.numero],
    ['Data',fmtDataSolic(o.data)],
    ['T√©cnico',o.tecnico],
    ['Endere√ßo',`${o.endereco||''}, ${o.bairro||''}`],
    ['Munic√≠pio/UF',`${o.municipio||''} - ${o.uf||''}`],
    ['CEP',o.cep||''],
    ['Tipo de Envio',o.envio||'Normal'],
    ['Observa√ß√µes',o.obs||'-'],
    ['Subtotal',o.subtotal||0],
    ['Desconto (R$)',o.descValor||0],
    ['Frete (R$)',o.frete||0],
    ['TOTAL',o.total||0],
    ['Fluxo',o.status||'Supervisor Diversey']
  ]);
  ws2['!cols']=[{wch:18},{wch:60}];
  XLSX.utils.book_append_sheet(wb,ws2,'Resumo');

  XLSX.writeFile(wb,`${o.numero||'SOLICITACAO'}.xlsx`);
  toast('Excel (.xlsx) gerado ‚úÖ');
}
function makeSafeFilename(s){ return (s||'').replace(/[\\\/:*?"<>|]+/g,'').trim() || 'SemTecnico'; }
async function baixarPDFFrom(o){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const M = 40, PAGE_W = doc.internal.pageSize.getWidth(), CONTENT_W = PAGE_W - M*2;

  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Solicita√ß√£o de Pe√ßas e Componentes', M, M);

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  let y = M + 24;
  doc.text(`N√∫mero: ${o.numero||'-'}`, M, y);
  doc.text(`Data: ${fmtDataSolic(o.data)||'-'}`, M + 260, y);
  y += 14;
  doc.text(`T√©cnico: ${o.tecnico||'-'}`, M, y); y += 14;
  doc.text(`Endere√ßo: ${(o.endereco||'-')}, ${(o.bairro||'')}`, M, y); y += 14;
  doc.text(`${o.municipio||''} - ${o.uf||''} ‚Ä¢ CEP: ${o.cep||''}`, M, y); y += 14;
  doc.text(`Envio: ${o.envio||'Normal'}`, M, y);

  if (o.obs) {
    y += 18; doc.setFont('helvetica','bold'); doc.text('Observa√ß√µes:', M, y);
    doc.setFont('helvetica','normal'); y += 12;
    const obs = doc.splitTextToSize(o.obs, CONTENT_W);
    doc.text(obs, M, y);
    y += obs.length * 12;
  }

  const COL_COD=60, COL_ID=115, COL_QTD=40, COL_VUNIT=65, COL_SUB=70;
  const COL_DESC = CONTENT_W - (COL_COD + COL_ID + COL_QTD + COL_VUNIT + COL_SUB);

  doc.autoTable({
    startY: y + 10,
    margin: { left: M, right: M },
    tableWidth: CONTENT_W,
    styles: { fontSize: 9, cellPadding: 6, overflow: 'linebreak' },
    headStyles: { fillColor: [30,64,175] },
    columnStyles: { 0:{cellWidth:COL_COD}, 1:{cellWidth:COL_ID}, 2:{cellWidth:COL_QTD, halign:'right'}, 3:{cellWidth:COL_DESC}, 4:{cellWidth:COL_VUNIT, halign:'right'}, 5:{cellWidth:COL_SUB, halign:'right'} },
    head: [['C√≥digo','ID M√°quina','Qtd','Descri√ß√£o','Valor Unit.','Subtotal']],
    body: (o.itens||[]).map(it=>[
      it.codigo||'', (it.idMaquina||''), it.qtd, it.descricao, BRL(it.valor), BRL(it.qtd*it.valor)
    ]),
    pageBreak: 'auto'
  });

  const fy = doc.lastAutoTable.finalY + 12;
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text('Resumo', M, fy);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  let ly = fy + 14;
  [
    `Subtotal: ${BRL(o.subtotal||0)}`,
    `Desconto (R$): ${BRL(o.descValor||0)}`,
    `Frete (R$): ${BRL(o.frete||0)}`,
    `TOTAL: ${BRL(o.total||0)}`,
    `Fluxo: ${o.status||'Supervisor Diversey'}`
  ].forEach(s => { doc.text(s, M, ly); ly += 14; });

  const blob = doc.output('blob');
  const safeTec = makeSafeFilename(o.tecnico);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${o.numero||'SOLICITACAO'} - ${safeTec}.pdf`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
  toast('PDF gerado ‚úÖ');
}

/* ========= Local ========= */
function salvarLocal(){
  const tecnico=$('#tecnico').value; if(!tecnico){ toast('Selecione o t√©cnico'); return false; }
  const itens=collectItems(); if(!itens.length){ toast('Inclua ao menos 1 item'); return false; }

  const tot=calcTotal();
  const dados={
    numero:$('#req-num').value, data:new Date().toISOString().slice(0,10),
    tecnico, endereco:$('#endereco').value, bairro:$('#bairro').value, municipio:$('#municipio').value, uf:$('#uf').value, cep:$('#cep').value,
    envio:$('#envio').value || 'Normal',
    obs:$('#obs').value, ...tot, itens,
    status:'Supervisor Diversey'
  };
  const lista=JSON.parse(localStorage.getItem(LS.ORD)||'[]');
  const i=lista.findIndex(o=>o.numero===dados.numero);
  if(i>=0){ dados.status = lista[i].status || dados.status; lista[i]=dados; } else { lista.push(dados); }
  localStorage.setItem(LS.ORD, JSON.stringify(lista));
  localStorage.setItem(LS.CUR, JSON.stringify(dados));
  montarHistoricoLocal();
  return true;
}
function updateStatusLocal(numero, novo){
  let lista=JSON.parse(localStorage.getItem(LS.ORD)||'[]');
  const i=lista.findIndex(o=>o.numero===numero);
  if(i<0) return false;
  lista[i].status = novo;
  localStorage.setItem(LS.ORD, JSON.stringify(lista));
  return true;
}

/* ========= Hist√≥rico (LOCAL) ========= */
function montarHistoricoLocal(){
  const tb=$('#tabela-hist tbody'); tb.innerHTML='';
  const lista=JSON.parse(localStorage.getItem(LS.ORD)||'[]');
  $('#hist').style.display=lista.length?'block':'none';

  for(const o of lista){
    const tr=document.createElement('tr');

    const tdSel = document.createElement('td');
    tdSel.style.textAlign = 'center';
    tdSel.innerHTML = `<input type="checkbox" class="hist-select" value="${o.numero}" title="Selecionar ${o.numero}">`;
    tr.appendChild(tdSel);

    const tdNum  = document.createElement('td'); tdNum.className='td-num';  tdNum.textContent = o.numero;
    const tdData = document.createElement('td'); tdData.className='td-data'; tdData.textContent = o.data;
    const tdTec  = document.createElement('td'); tdTec.className='td-tec';  tdTec.textContent  = o.tecnico || '-';
    const tdItens= document.createElement('td'); tdItens.textContent = o.itens?.length || 0;
    const tdTot  = document.createElement('td'); tdTot.textContent   = BRL(o.total||0);

    tr.appendChild(tdNum);
    tr.appendChild(tdData);
    tr.appendChild(tdTec);
    tr.appendChild(tdItens);
    tr.appendChild(tdTot);

    const sel=makeFlowSelect(o.status||'Supervisor Diversey', false);
    sel.addEventListener('change',()=>{
      if(sel.value==='Entregue'){
        const ok=confirm('Confirmar entrega do material para marcar como "Entregue"?');
        if(!ok){ sel.value=o.status||'Supervisor Diversey'; applyFlowStyle(sel, sel.value); return; }
      }
      updateStatusLocal(o.numero, sel.value);
      o.status=sel.value;
      toast('Fluxo atualizado: '+sel.value);
    });
    const tdStatus=document.createElement('td'); tdStatus.appendChild(sel);
    tr.appendChild(tdStatus);

    const tdAcoes=document.createElement('td');
    const bAbrir=document.createElement('button'); bAbrir.textContent='Abrir';
    bAbrir.addEventListener('click',()=>abrirLocal(o.numero));
    const bExcel=document.createElement('button'); bExcel.textContent='üìä Excel';
    bExcel.addEventListener('click',()=>exportXLSXFrom(o));
    const bPdf=document.createElement('button'); bPdf.textContent='üìÑ PDF';
    bPdf.addEventListener('click',()=>baixarPDFFrom(o));
    tdAcoes.appendChild(bAbrir);
    tdAcoes.appendChild(bExcel);
    tdAcoes.appendChild(bPdf);
    tr.appendChild(tdAcoes);

    tb.appendChild(tr);
  }

  bindSelectAll();
  bindFiltros();
  aplicaFiltrosLinhas($$('#tabela-hist tbody tr'));
}
function abrirLocal(num){
  const lista=JSON.parse(localStorage.getItem(LS.ORD)||'[]');
  const o=lista.find(x=>x.numero===num); if(!o) return;
  $('#req-num').value=o.numero;
  $('#tecnico').value=o.tecnico; preencherEndereco(o.tecnico);
  $('#envio').value=o.envio||'Normal';
  $('#obs').value=o.obs||'';
  $('#desc-valor').value=o.descValor||0;
  $('#frete').value=o.frete||0;
  const tbody=$('#tabela-itens tbody'); tbody.innerHTML='';
  (o.itens||[]).forEach(it=>addRow(it));
  calcTotal(); toast('Solicita√ß√£o carregada');
}

/* ========= Excel/PDF do formul√°rio atual ========= */
function getOrder(){
  const it=collectItems(), c=calcTotal();
  return {
    numero:$('#req-num').value, data:new Date().toISOString().slice(0,10),
    tecnico:$('#tecnico').value, endereco:$('#endereco').value, bairro:$('#bairro').value,
    municipio:$('#municipio').value, uf:$('#uf').value, cep:$('#cep').value,
    envio:$('#envio').value || 'Normal', obs:$('#obs').value,
    itens:it, subtotal:c.subtotal, total:c.total, descValor:c.descValor, frete:c.frete,
    status:'Supervisor Diversey'
  };
}
function exportXLSX(){ exportXLSXFrom(getOrder()); }
async function baixarPDF(){ await baixarPDFFrom(getOrder()); }

/* ========= GLOBAL (Flow) ========= */
async function listarGlobalExcel(){
  if(!API_LIST || API_LIST.startsWith('COLE_AQUI')) throw new Error('API_LIST n√£o configurada');
  const r=await fetch(API_LIST); if(!r.ok) throw new Error('Falha ao listar no Flow');
  const j=await r.json(); if(!j.success) throw new Error('Resposta inv√°lida do Flow');
  const rows=j.rows||[];
  return rows.map(r=>({
    numero:r.Numero, data:r.Data, tecnico:r.Tecnico, endereco:r.Endereco, bairro:r.Bairro,
    municipio:r.Municipio, uf:r.UF, cep:r.CEP,
    envio:r.Envio||'Normal',
    subtotal:Number(r.Subtotal||0), descValor:Number(r.DescontoValor||0),
    frete:Number(r.Frete||0), total:Number(r.Total||0),
    status:r.Status||'Supervisor Diversey',
    itens:(()=>{ try{return JSON.parse(r.ItensJson||'[]')}catch{return[]} })()
  }));
}
async function atualizarStatusGlobal(numero, novoStatus){
  if(!API_UPDATE_STATUS || API_UPDATE_STATUS.startsWith('COLE_AQUI')) throw new Error('API_UPDATE_STATUS n√£o configurada');
  const payload = { numero, status: novoStatus };
  const r = await fetch(API_UPDATE_STATUS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!r.ok) throw new Error('Falha ao atualizar status no Flow');
  const j = await r.json(); if(!j.success) throw new Error('Resposta inv√°lida do Flow');
  return true;
}

/* ========= Boot ========= */
function novaSolicitacao(){
  $('#tecnico').value=''; $('#endereco').value=''; $('#bairro').value='';
  $('#municipio').value=''; $('#uf').value=''; $('#cep').value='';
  $('#envio').value='Normal';
  $('#obs').value=''; $('#desc-valor').value=0; $('#frete').value=0;
  $('#tabela-itens tbody').innerHTML='';
  gerarNumero(); addRow(); toast('Nova solicita√ß√£o iniciada üîÑ');
}
function boot(){
  if(localStorage.getItem(LS.THEME)==='light') document.documentElement.classList.add('light');
  $('#btn-theme').addEventListener('click',()=>{document.documentElement.classList.toggle('light');localStorage.setItem(LS.THEME,document.documentElement.classList.contains('light')?'light':'dark');});
  $('#btn-modo-local').addEventListener('click',()=>setModo('local'));
  $('#btn-modo-global').addEventListener('click',()=>setModo('global'));

  $('#btn-pdf').addEventListener('click',baixarPDF);
  $('#btn-xlsx').addEventListener('click',exportXLSX);

  $('#btn-auditar').addEventListener('click',()=>{
    const rep = auditarPedido(); showAuditModal(rep);
  });

  $('#btn-enviar').addEventListener('click',()=>{
    const rep = auditarPedido();
    if(!rep.ok){
      showAuditModal(rep,{ onIgnoreSend: ()=>{
        const ok = salvarLocal();
        if(ok){ novaSolicitacao(); }
      }});
      return;
    }
    const ok = salvarLocal();
    if(ok){ novaSolicitacao(); }
  });

  document.getElementById('hist-del').addEventListener('click', ()=>{
    if(getModo()==='global'){
      toast('Exclus√£o no modo GLOBAL n√£o est√° implementada.');
      return;
    }
    excluirSelecionadosLocal();
  });

  $('#btn-hist').addEventListener('click',async()=>{
    const hist=$('#hist'); const tbody=$('#tabela-hist tbody'); tbody.innerHTML='';
    if(getModo()==='global'){
      try{
        const lista=await listarGlobalExcel(); 
        if(!lista.length){ hist.style.display='none'; return; }
        hist.style.display='block';
        for(const o of lista){
          const tr=document.createElement('tr');

          const tdSel = document.createElement('td');
          tdSel.style.textAlign='center';
          tdSel.innerHTML = `<input type="checkbox" class="hist-select" value="${o.numero}" title="Selecionar ${o.numero}">`;
          tr.appendChild(tdSel);

          const tdNum  = document.createElement('td'); tdNum.className='td-num'; tdNum.textContent = o.numero;
          const tdData = document.createElement('td'); tdData.className='td-data'; tdData.textContent = o.data;
          const tdTec  = document.createElement('td'); tdTec.className='td-tec'; tdTec.textContent  = o.tecnico || '-';
          const tdItens= document.createElement('td'); tdItens.textContent = o.itens?.length || 0;
          const tdTot  = document.createElement('td'); tdTot.textContent = BRL(o.total||0);

          tr.appendChild(tdNum);
          tr.appendChild(tdData);
          tr.appendChild(tdTec);
          tr.appendChild(tdItens);
          tr.appendChild(tdTot);

          const sel=makeFlowSelect(o.status||'Supervisor Diversey', false);
          sel.addEventListener('change', async ()=>{
            let newVal = sel.value;
            if(newVal==='Entregue'){
              const ok=confirm('Confirmar entrega do material para marcar como "Entregue"?');
              if(!ok){ sel.value=o.status||'Supervisor Diversey'; applyFlowStyle(sel, sel.value); return; }
            }
            try{
              await atualizarStatusGlobal(o.numero, newVal);
              toast('Fluxo atualizado no GLOBAL: '+newVal);
              o.status=newVal;
            }catch(e){
              console.error(e);
              toast('Falha ao atualizar no GLOBAL ‚Äî fluxo n√£o alterado');
              sel.value = o.status||'Supervisor Diversey';
              applyFlowStyle(sel, sel.value);
            }
          });
          const tdStatus=document.createElement('td'); tdStatus.appendChild(sel);
          tr.appendChild(tdStatus);

          const tdA=document.createElement('td');
          const bExcel=document.createElement('button'); bExcel.textContent='üìä Excel';
          bExcel.addEventListener('click',()=>exportXLSXFrom(o));
          const bPdf=document.createElement('button'); bPdf.textContent='üìÑ PDF';
          bPdf.addEventListener('click',()=>baixarPDFFrom(o));
          tdA.appendChild(bExcel);
          tdA.appendChild(bPdf);
          tr.appendChild(tdA);

          tbody.appendChild(tr);
        }
        hist.style.display='block';
        bindSelectAll();
        bindFiltros();
        aplicaFiltrosLinhas($$('#tabela-hist tbody tr'));
      }catch(e){ console.error(e); toast('Erro no Excel ‚Äî mostrando LOCAL'); montarHistoricoLocal(); }
    } else {
      montarHistoricoLocal();
    }
  });

  $('#btn-ocultar-hist').addEventListener('click',()=>{
    $('#hist').style.display='none';
    toast('Hist√≥rico ocultado');
  });

  $('#btn-nova').addEventListener('click',()=>{ const ok = salvarLocal(); if(ok){ novaSolicitacao(); } });

  preencherListas();
  $('#tecnico').addEventListener('input',()=>preencherEndereco($('#tecnico').value));

  $('#add-item').addEventListener('click',()=>addRow());
  document.addEventListener('keydown', (ev)=>{
    if(ev.ctrlKey && ev.key === 'Enter'){ ev.preventDefault(); addRow(); }
    if(ev.ctrlKey && (ev.key.toLowerCase() === 'e')){ ev.preventDefault(); $('#btn-enviar').click(); }
  });

  $('#badge-modo').textContent='Modo: '+getModo().toUpperCase();
  novaSolicitacao();
}

/* ========= Auditoria ========= */
function auditarPedido(){
  $$('#tabela-itens tbody tr').forEach(tr=>tr.classList.remove('row-error'));
  const issues=[]; const seenPair = new Map(); let hasBlocking = false;

  $$('#tabela-itens tbody tr').forEach((tr,idx)=>{
    const row = idx+1;
    const idEl = tr.querySelector('.idmaq');
    const id = normalizeId(idEl.value||'');
    const cod = (tr.querySelector('.codigo').value||'').trim().toUpperCase();
    const qtd = clamp(parseFloat(tr.querySelector('.qtd').value),1,9999);
    const val = Math.max(0, parseFloat(tr.querySelector('.valor').value)||0);
    const desc = (tr.querySelector('.desc').value||'').trim();

    if(!(val>0)){ issues.push({row,type:'Pre√ßo inv√°lido',level:'warn',msg:`Linha ${row}: valor unit√°rio n√£o preenchido ou zero.`}); tr.classList.add('row-error'); }
    if(!(qtd>=1)){ issues.push({row,type:'Qtd inv√°lida',level:'warn',msg:`Linha ${row}: quantidade deve ser ‚â• 1.`}); tr.classList.add('row-error'); }
    if(!desc){ issues.push({row,type:'Descri√ß√£o faltando',level:'warn',msg:`Linha ${row}: descri√ß√£o do item est√° vazia.`}); tr.classList.add('row-error'); }

    if(id && cod){
      const key = cod+'|'+id;
      const arr = seenPair.get(key) || [];
      arr.push(row); seenPair.set(key,arr);
    }
  });

  for(const [pair,rows] of seenPair.entries()){
    if(rows.length>1){
      rows.forEach(r=>{
        const tr=$('#tabela-itens tbody').children[r-1];
        tr.classList.add('row-error');
      });
      issues.push({row:null,type:'Duplicidade C√≥digo+ID',level:'block',msg:`Par (C√≥digo+ID) repetido nas linhas ${rows.join(', ')} ‚Äî unifique quantidades.`});
      hasBlocking = true;
    }
  }
  return { ok: !hasBlocking, issues, hasBlocking };
}
function showAuditModal(report, {onIgnoreSend}={}){
  const back = $('#modal-audit');
  const list = $('#audit-issues');
  const sum = $('#audit-summary');
  const btnIgnore = $('#audit-ignore');

  list.innerHTML='';
  if(report.issues.length===0){
    sum.textContent = 'Tudo certo ‚úÖ ‚Äî nenhuma inconsist√™ncia encontrada.';
  } else {
    const counts = report.issues.reduce((acc,i)=>{ acc[i.level]=(acc[i.level]||0)+1; return acc; },{});
    const parts = Object.entries(counts).map(([k,v])=>(k==='block'?'bloqueios':'avisos')+': '+v).join(' ‚Ä¢ ');
    sum.textContent = `Foram encontradas ${report.issues.length} ocorr√™ncias ‚Äî ${parts}.`;
    report.issues.forEach(it=>{
      const div=document.createElement('div');
      div.className='issue';
      div.textContent = '‚Ä¢ ' + it.msg;
      list.appendChild(div);
    });
  }

  btnIgnore.style.display= report.hasBlocking ? 'none' : 'inline-block';

  back.style.display='flex';
  const close = ()=> back.style.display='none';
  $('#audit-close').onclick = close;
  $('#audit-fix').onclick = close;
  btnIgnore.onclick = ()=>{ close(); if(typeof onIgnoreSend==='function') onIgnoreSend(); };
}

if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot); } else { boot(); }
</script>
</body>
</html>
